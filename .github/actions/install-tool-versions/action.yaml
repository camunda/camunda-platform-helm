name: Install Tools
description: Install tools via asdf vm.
inputs:
  tools:
    default: ""
    description: |
      Line separated tool names to be installed,
      as asdf action doesn't have to install certain tools from .tool-versions file.
      Note: The tool name should match what's in the .tool-versions file.

runs:
  using: composite
  steps:
    - name: Mark repo as safe for git
      shell: bash
      run: |
        # Mark the repo as safe for Git by setting the safe.directory config option. This is required for running jobs in containers like the playwright integration tests.
        git config --global --add safe.directory "$GITHUB_WORKSPACE"

    - name: Filter .tool-versions
      shell: bash
      run: |
        cp -a .tool-versions .tool-versions-orig
        echo "${{ inputs.tools }}" | sed '/^$/d' > .tool-versions-input
        echo "⭐ Input tool names content:"
        cat .tool-versions-input
        grep -w -f .tool-versions-input .tool-versions-orig > .tool-versions
        echo "⭐ Filtered .tool-versions content:"
        cat .tool-versions

    - name: Restore cache
      uses: actions/cache/restore@0400d5f644dc74513175e3cd8d07132dd4860809 # v4
      with:
        # Using $HOME instead of /home/runner as inside of the container the home directory is might not be /home/runner.
        path: $HOME/.asdf
        key: ${{ runner.os }}-tools-${{ hashFiles('.tool-versions') }}

    - name: Install asdf and tools
      uses: asdf-vm/actions/install@1902764435ca0dd2f3388eea723a4f92a4eb8302 # v4
      env:
        # Use GNU mirror to avoid overloading ftp.gnu.org
        # See: https://www.gnu.org/prep/ftp.en.html
        # Used by asdf-make: https://github.com/yacchi/asdf-make/blob/2b8c33adca11b79158298f1e35fe6a9ea363b6b0/lib/utils.bash#L7
        MAKE_CUSTOM_MIRROR: https://ftpmirror.gnu.org/
      with:
        # TODO: Upgrade to 0.16 when it's supported in the GHA.
        asdf_branch: v0.15.0

    - name: Print asdf build logs
      if: always()
      shell: bash
      env:
        ASDF_DIR: ${{ env.ASDF_DIR }}
      run: |
        set -euo pipefail
        root="${ASDF_DIR:-$HOME/.asdf}/downloads"
        if [ -d "$root" ]; then
          echo "=== asdf installer logs under $root ==="
          # Group each log in the Actions UI
          while IFS= read -r -d '' f; do
            echo "::group::${f#$root/}"
            cat "$f" || true
            echo "::endgroup::"
          done < <(find "$root" -type f -name install.log -print0)
        else
          echo "No asdf downloads dir at $root"
        fi

    - name: Save cache
      uses: actions/cache/save@0400d5f644dc74513175e3cd8d07132dd4860809 # v4
      with:
        path: $HOME/.asdf
        key: ${{ runner.os }}-tools-${{ hashFiles('.tool-versions') }}

    - name: List installed versions
      shell: bash
      run: |
        asdf current

    - name: Checkout .tool-versions changes
      shell: bash
      run: |
        git clean -f .tool-versions*
        git checkout .tool-versions
