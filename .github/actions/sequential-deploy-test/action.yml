name: 'Upgrade and test'
description: 'In test-integration-sequential, it can be pretty repetitive to upgrade, then test, then upgrade. This performs the action in a single step.'

inputs:
  chart-version:
    description: 'chart version intended to be major.minor matching the charts dir. example: 8.5'
    required: true
  chart-version-dash:
    description: 'chart version intended to be major-minor matching the charts dir. Just used in the ID for the test-type-vars action. example: 8-5'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Set test type vars
      id: test-type-vars-${{ inputs.chart-version-dash }}
      uses: ./.github/actions/test-type-vars
      with:
        chart-dir: "camunda-platform-${{ inputs.chart-version }}"
    - name: Pre Upgrade
      run: |
        task -d test/integration/scenarios/chart-full-setup upgrade.pre
    - name: üåü Upgrade Camunda chart üåü
      env:
        TEST_OPENSHIFT_POST_RENDER: ${{ inputs.camunda-helm-post-render }}
        TEST_CASE: ${{ inputs.test-case }}
        TEST_VALUES_SCENARIO: base
        TEST_CHART_NAME: ../../../../charts/camunda-platform-${{ inputs.chart-version }}
        TEST_VALUES_BASE_DIR: ../../../../charts/camunda-platform-${{ inputs.chart-version }}/test/integration/scenarios
        TEST_CHART_DIR: ../../../../charts/camunda-platform-${{ inputs.chart-version }}
        TEST_HELM_EXTRA_ARGS: >-
          ${{ env.TEST_HELM_EXTRA_ARGS_UPGRADE }}
          --set global.ingress.host=${{ steps.vars.outputs.ingress-host }}
          --values ${{ steps.test-type-vars-8-5.outputs.valuesBaseDir }}/infra/values-infra-preemptible.yaml
          --values /tmp/extra-values-file.yaml
      run: |
        task -d test/integration/scenarios/chart-full-setup upgrade.exec
    - name: ‚≠êÔ∏è Run Preflight TestSuite ‚≠êÔ∏è
      timeout-minutes: 10
      run: |
        task -d test/integration/scenarios/chart-full-setup test.preflight
    - name: ‚≠êÔ∏è Run Core TestSuite ‚≠êÔ∏è
      timeout-minutes: 20
      run: |
        task -d test/integration/scenarios/chart-full-setup test.core

