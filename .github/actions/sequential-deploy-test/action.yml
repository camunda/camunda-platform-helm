name: 'Upgrade and test'
description: 'In test-integration-sequential, it can be pretty repetitive to upgrade, then test, then upgrade. This performs the action in a single step.'

inputs:
  chart-version:
    description: 'chart version intended to be major.minor matching the charts dir. example: 8.5'
    required: true
  infra-values:
    description: 'Path to the infra values file'
    required: true
  ingress-host:
    description: 'url for the tests'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Pre Upgrade
      shell: bash
      run: |
        task -d test/integration/scenarios/chart-full-setup upgrade.pre
    - name: üåü Upgrade Camunda chart üåü
      shell: bash
      env:
        TEST_VALUES_SCENARIO: base
        TEST_CHART_NAME: ../../../../charts/camunda-platform-${{ inputs.chart-version }}
        TEST_VALUES_BASE_DIR: ../../../../charts/camunda-platform-${{ inputs.chart-version }}/test/integration/scenarios
        TEST_CHART_DIR: ../../../../charts/camunda-platform-${{ inputs.chart-version }}
        TEST_HELM_EXTRA_ARGS: >-
          ${{ env.TEST_HELM_EXTRA_ARGS_UPGRADE }}
          --set global.ingress.host=${{ inputs.ingress-host }}
          --values ${{ inputs.infra-values }}
          --values /tmp/extra-values-file.yaml
      run: |
        task -d test/integration/scenarios/chart-full-setup upgrade.exec
    - name: ‚≠êÔ∏è Run Preflight TestSuite ‚≠êÔ∏è
      shell: bash
      run: |
        task -d test/integration/scenarios/chart-full-setup test.preflight
    - name: ‚≠êÔ∏è Run Core TestSuite ‚≠êÔ∏è
      shell: bash
      run: |
        task -d test/integration/scenarios/chart-full-setup test.core

