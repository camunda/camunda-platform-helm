name: Validate Documentation Links
description: |
  Validates that all https://docs.camunda.* URLs in chart directories
  return successful HTTP responses (no 404s or other errors).

inputs:
  chart-versions:
    description: Space-separated list of chart versions to validate (e.g., "8.9 8.8 8.7")
    required: true

outputs:
  total-checked:
    description: Total number of unique links checked
    value: ${{ steps.validate.outputs.total-checked }}
  invalid-count:
    description: Number of invalid links found
    value: ${{ steps.validate.outputs.invalid-count }}

runs:
  using: composite
  steps:
    - name: Validate documentation links
      id: validate
      shell: bash
      run: |
        set +e  # Don't exit on first error - collect all failures

        VERSIONS="${{ inputs.chart-versions }}"

        # Associative array: URL -> space-separated list of "file:line" locations
        declare -A URL_LOCATIONS

        # Phase 1: Collect all URLs and their locations
        echo "Phase 1: Collecting documentation links..."
        echo ""

        for version in $VERSIONS; do
          CHART_DIR="charts/camunda-platform-${version}"

          if [[ ! -d "$CHART_DIR" ]]; then
            echo "::warning::Chart directory not found: $CHART_DIR"
            continue
          fi

          echo "  Scanning $CHART_DIR..."

          while IFS=: read -r file line content; do
            # Extract URL from the line
            url=$(echo "$content" | grep -oE 'https://docs\.camunda\.[^[:space:]\)\"'\''<>]*' | head -1)

            # Clean trailing punctuation that might be captured
            url=$(echo "$url" | sed 's/[,;:]*$//')

            if [[ -n "$url" ]]; then
              # Append location to the URL's location list
              if [[ -z "${URL_LOCATIONS[$url]:-}" ]]; then
                URL_LOCATIONS["$url"]="${file}:${line}"
              else
                URL_LOCATIONS["$url"]="${URL_LOCATIONS[$url]} ${file}:${line}"
              fi
            fi
          done < <(grep -rn 'https://docs\.camunda\.' "$CHART_DIR" 2>/dev/null || true)
        done

        TOTAL_URLS=${#URL_LOCATIONS[@]}
        echo ""
        echo "Found $TOTAL_URLS unique URLs to validate"
        echo ""

        # Phase 2: Validate each unique URL once
        echo "Phase 2: Validating URLs..."
        echo ""

        declare -A INVALID_URLS  # URL -> HTTP code
        VALID_COUNT=0

        for url in "${!URL_LOCATIONS[@]}"; do
          # Check if URL is valid (follows redirects, max 10 seconds)
          HTTP_CODE=$(curl -sL --max-time 10 -o /dev/null -w "%{http_code}" "$url" 2>/dev/null || echo "000")

          if [[ "$HTTP_CODE" -ge 200 && "$HTTP_CODE" -lt 400 ]]; then
            echo "  [VALID] $url"
            ((VALID_COUNT++))
          else
            echo "  [INVALID] $url (HTTP $HTTP_CODE)"
            INVALID_URLS["$url"]="$HTTP_CODE"
          fi
        done

        # Phase 3: Report results
        echo ""
        echo "========================================="
        echo "Summary: Checked $TOTAL_URLS unique URLs"
        echo "========================================="

        # Set outputs
        echo "total-checked=${TOTAL_URLS}" >> $GITHUB_OUTPUT
        echo "invalid-count=${#INVALID_URLS[@]}" >> $GITHUB_OUTPUT

        if [[ ${#INVALID_URLS[@]} -gt 0 ]]; then
          echo ""
          echo "Found ${#INVALID_URLS[@]} invalid URL(s):"
          echo ""

          # For each invalid URL, report all locations where it was found
          for url in "${!INVALID_URLS[@]}"; do
            HTTP_CODE="${INVALID_URLS[$url]}"
            locations="${URL_LOCATIONS[$url]}"

            echo "  $url (HTTP $HTTP_CODE)"
            echo "    Found in:"

            # Split locations and emit GitHub error annotations
            for location in $locations; do
              file="${location%%:*}"
              line="${location##*:}"
              echo "      - $location"
              echo "::error file=${file},line=${line}::Invalid documentation link (HTTP ${HTTP_CODE}): $url"
            done
            echo ""
          done

          exit 1
        else
          echo ""
          echo "All documentation links are valid!"
        fi
