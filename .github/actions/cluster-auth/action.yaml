name: cluster-auth
description: Generate GH token and log in to GKE/ROSA or decrypt kubeconfig
inputs:
  platform:         { required: true,  description: gke | rosa | custom }
  auth-data:        { required: false, description: base64-encrypted kubeconfig }

outputs:
  token:
    description: GitHub token
    value: ${{ steps.generate-github-token.outputs.token }}

env:
  GH_APP_ID:        {}
  GH_APP_KEY:       {}
  GKE_CLUSTER_NAME: {}
  GKE_CLUSTER_LOC:  {}
  GKE_WIP:          {}
  GKE_SA:           {}
  ROSA_URL:         {}
  ROSA_USER:        {}
  ROSA_PASS:        {}
  CLUSTER_NAME:     {}
  TELEPORT_TOKEN:   {}

runs:
  using: "composite"
  steps:
    - name: Generate GitHub token
      uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2
      id: generate-github-token
      with:
        app_id:      ${{ env.GH_APP_ID }}
        private_key: ${{ env.GH_APP_KEY }}

    - name: Authenticate to GKE
      if: inputs.platform == 'gke' && inputs.auth-data == ''
      uses: ./.github/actions/gke-login
      with:
        cluster-name:                ${{ env.GKE_CLUSTER_NAME }}
        cluster-location:            ${{ env.GKE_CLUSTER_LOC }}
        workload-identity-provider:  ${{ env.GKE_WIP }}
        service-account:             ${{ env.GKE_SA }}

    - name: Authenticate to OpenShift
      if: inputs.platform == 'rosa' && inputs.auth-data == ''
      uses: redhat-actions/oc-login@5eb45e848b168b6bf6b8fe7f1561003c12e3c99d # v1
      with:
        openshift_server_url: ${{ env.ROSA_URL }}
        openshift_username:   ${{ env.ROSA_USER }}
        openshift_password:   ${{ env.ROSA_PASS }}

    - name: Set up Teleport
      if: inputs.platform == 'eks'
      uses: teleport-actions/setup@a820ebbf1bc1a496efca348ad21042d6e8df73a6 # v1
      with:
        version: 17.2.2

    # Authenticate with Teleport for EKS clusters using tbot with retry logic.
    # 
    # Why retry logic is needed:
    # The teleport-actions/auth-k8s GitHub Action occasionally fails with intermittent
    # errors like "invalid character 'u' looking for beginning of value" due to transient
    # issues with the Teleport service. These failures are not configuration problems but
    # rather infrastructure hiccups that resolve on retry.
    #
    # Instead of using the teleport-actions/auth-k8s action directly (which doesn't support
    # retries), we use tbot directly with a config file to authenticate. This gives us
    # control over retry behavior with exponential backoff (30s, 60s, 120s delays).
    - name: Authenticate with Teleport (with retry)
      if: inputs.platform == 'eks' && inputs.auth-data == ''
      id: teleport-auth
      shell: bash
      env:
        TELEPORT_PROXY: "camunda.teleport.sh:443"
        TELEPORT_TOKEN: ${{ env.TELEPORT_TOKEN }}
        KUBERNETES_CLUSTER: ${{ env.CLUSTER_NAME }}
      run: |
        set -euo pipefail

        MAX_RETRIES=3
        RETRY_DELAY=30

        teleport_auth() {
          echo "Authenticating with Teleport..."
          
          # Create destination directory for tbot output
          DEST_DIR="${HOME}/.tbot-output"
          mkdir -p "${DEST_DIR}"

          # Generate tbot config file for kubernetes output.
          # This is equivalent to what teleport-actions/auth-k8s does internally.
          # Using printf to avoid heredoc indentation issues in YAML.
          printf '%s\n' \
            "version: v2" \
            "proxy_server: \"${TELEPORT_PROXY}\"" \
            "onboarding:" \
            "  join_method: github" \
            "  token: \"${TELEPORT_TOKEN}\"" \
            "storage:" \
            "  type: memory" \
            "outputs:" \
            "  - type: kubernetes" \
            "    kubernetes_cluster: \"${KUBERNETES_CLUSTER}\"" \
            "    destination:" \
            "      type: directory" \
            "      path: \"${DEST_DIR}\"" \
            > /tmp/tbot-config.yaml

          # Run tbot in oneshot mode to generate credentials and exit
          tbot start -c /tmp/tbot-config.yaml --oneshot

          # Set KUBECONFIG environment variable for subsequent steps.
          # Note: tbot outputs the file as "kubeconfig.yaml" (not "kubeconfig")
          KUBECONFIG_PATH="${DEST_DIR}/kubeconfig.yaml"
          if [[ -f "${KUBECONFIG_PATH}" ]]; then
            echo "KUBECONFIG=${KUBECONFIG_PATH}" >> "$GITHUB_ENV"
            echo "Teleport authentication successful"
          else
            echo "ERROR: kubeconfig not found at ${KUBECONFIG_PATH}"
            echo "Contents of ${DEST_DIR}:"
            ls -la "${DEST_DIR}" || true
            return 1
          fi
        }

        # Retry loop with exponential backoff
        for attempt in $(seq 1 ${MAX_RETRIES}); do
          echo "=== Teleport authentication attempt ${attempt}/${MAX_RETRIES} ==="
          
          if teleport_auth; then
            echo "✅ Teleport authentication succeeded on attempt ${attempt}"
            exit 0
          else
            EXIT_CODE=$?
            echo "❌ Teleport authentication failed on attempt ${attempt} with exit code ${EXIT_CODE}"
            
            if [[ ${attempt} -lt ${MAX_RETRIES} ]]; then
              echo "Waiting ${RETRY_DELAY} seconds before retry..."
              sleep ${RETRY_DELAY}
              # Exponential backoff: 30s -> 60s -> 120s
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          fi
        done

        echo "❌ Teleport authentication failed after ${MAX_RETRIES} attempts"
        exit 1

    - name: Authenticate via var
      if: inputs.auth-data != ''
      shell: bash
      run: |
        mkdir -p "$HOME/.kube"
        echo "${{ inputs.auth-data }}" | base64 -d > enc.cfg
        openssl enc -aes-256-cbc -d -in enc.cfg -out "$HOME/.kube/config" \
               -pass pass:"${{ steps.generate-github-token.outputs.token }}" -pbkdf2
        rm enc.cfg
        chmod 600 "$HOME/.kube/config"
