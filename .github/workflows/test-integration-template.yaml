# Docs: https://github.com/camunda/camunda-platform-helm/blob/main/docs/gha-workflows.md
name: "Test - Integration - Template"

on:
  workflow_call:
    inputs:
      identifier:
        description: The unique identifier of used in the deployment hostname.
        required: true
        type: string
      camunda-helm-git-ref:
        required: false
        default: main
        type: string
      caller-git-ref:
        required: false
        default: main
        type: string
      persistent:
        description: |
          Keep test deployment after the workflow is done.
          NOTE: All persistent deployments will be deleted frequently to save costs!
        required: false
        default: false
        type: boolean
      platforms:
        default: gke
        type: string
      flows:
        required: false
        default: install
        type: string
      test-enabled:
        required: false
        default: true
        type: boolean
      extra-values:
        description: Pass extra values to the Helm chart.
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ inputs.identifier }}
  cancel-in-progress: true

env:
  TEST_PERSISTENT: ${{ inputs.persistent }}
  TEST_HOSTNAME_BASE: ci.distro.ultrawombat.com
  TEST_SCENARIOS_DIR: charts/camunda-platform/test/integration/scenarios
  # Docker Hub auth to avoid image pull rate limit.
  TEST_CREATE_DOCKER_LOGIN_SECRET: "TRUE"
  TEST_DOCKER_USERNAME: ${{ secrets.DISTRO_CI_DOCKER_USERNAME_DOCKERHUB }}
  TEST_DOCKER_PASSWORD: ${{ secrets.DISTRO_CI_DOCKER_PASSWORD_DOCKERHUB }}
  # Camunda registry auth to access WebModeler Docker image since it's not public.
  TEST_DOCKER_USERNAME_CAMUNDA_CLOUD: ${{ secrets.DISTRO_CI_DOCKER_USERNAME_CAMUNDA }}
  TEST_DOCKER_PASSWORD_CAMUNDA_CLOUD: ${{ secrets.DISTRO_CI_DOCKER_PASSWORD_CAMUNDA }}

permissions:
  contents: read
  
jobs:
  test:
    name: ${{ inputs.platforms }} - ${{ matrix.scenario.name }}
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      deployments: write
    strategy:
      fail-fast: false
      matrix:
        scenario:
        - name: Chart Setup
          desc: Setup chart in production-like setup with Ingress and TLS.
          flow: install
          if: ${{ contains(inputs.flows, 'install') }}
        - name: Chart Upgrade
          desc: Upgrade chart from the latest released version to the current branch.
          flow: upgrade
          if: ${{ contains(inputs.flows, 'upgrade') }}
        exclude:
        - scenario:
            if: false
    env:
      TEST_CLUSTER_TYPE: ${{ matrix.distro.type }}
    steps:
    - uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4
      with:
        # This is needed to load repo GH composite actions if the workflow triggered by workflow_call.
        repository: camunda/camunda-platform-helm
        ref: ${{ inputs.camunda-helm-git-ref }}
    # Used to create/delete GitHub environment.
    # NOTE: The GH app requires "administration:write" access to be able to delete the GH environment.
    - name: Generate GitHub token
      uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2
      id: generate-github-token
      with:
        app_id: ${{ secrets.GH_APP_ID_DISTRO_CI_MANAGE_GH_ENVS }}
        private_key: ${{ secrets.GH_APP_PRIVATE_KEY_DISTRO_CI_MANAGE_GH_ENVS }}

    - name: Set workflow vars
      id: vars
      uses: ./.github/actions/workflow-vars
      with:
        persistent: ${{ env.TEST_PERSISTENT }}
        setup-flow: ${{ matrix.scenario.flow }}
        platform: ${{ matrix.distro.platform }}
        identifier-base: ${{ inputs.identifier }}
        ingress-hostname-base: ${{ env.TEST_HOSTNAME_BASE }}
  
    - name: Install env dependencies
      uses: asdf-vm/actions/install@05e0d2ed97b598bfce82fd30daf324ae0c4570e6 # v3
    - name: Add Helm repos and dependencies
      run: |
        make helm.repos-add
        make helm.dependency-update
  
    - name: Create test namespace
      run: |
        echo $TEST_NAMESPACE
        kubectl delete ns --ignore-not-found=true \
          -l "github-id=${{ steps.vars.outputs.identifier }},test-flow=${{ matrix.scenario.flow }},test-persistent=true"
        kubectl create ns $TEST_NAMESPACE
        kubectl label ns $TEST_NAMESPACE github-run-id=$GITHUB_WORKFLOW_RUN_ID
        kubectl label ns $TEST_NAMESPACE github-job-id=$GITHUB_WORKFLOW_JOB_ID
        kubectl label ns $TEST_NAMESPACE github-id=${{ steps.vars.outputs.identifier }}
        kubectl label ns $TEST_NAMESPACE test-flow=${{ matrix.scenario.flow }}
        kubectl label ns $TEST_NAMESPACE test-persistent=${{ env.TEST_PERSISTENT }}
  
    - name: Copy PRs wildcard certificate
      run: |
        kubectl apply -n $TEST_NAMESPACE -f .github/config/external-secret.yaml
  
    - name: Start GitHub deployment
      uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8 # v1
      id: deployment
      with:
        step: start
        token: ${{ steps.generate-github-token.outputs.token }}
        env: ${{ steps.vars.outputs.identifier }}
        ref: ${{ inputs.caller-git-ref }}

    - name: Pre setup
      timeout-minutes: 5
      env:
        TEST_CHART_FLOW: ${{ matrix.scenario.flow }}
        TEST_INGRESS_HOST: ${{ steps.vars.outputs.ingress-host }}
      run: |
        task -d $TEST_SCENARIOS_DIR/chart-full-setup setup.pre

        echo "Extra values from workflow:"
        echo "${{ inputs.extra-values }}" > /tmp/extra-values-file.yaml
        cat /tmp/extra-values-file.yaml

    - name: üåü Setup Camunda chart üåü
      env:
        TEST_CHART_FLOW: ${{ matrix.scenario.flow }}
        TEST_HELM_EXTRA_ARGS: >-
          --set global.ingress.host=${{ steps.vars.outputs.ingress-host }}
          --values /tmp/extra-values-file.yaml
        TEST_PROMETHEUS_HELM_EXTRA_ARGS: "--set host=${{ steps.ingress.outputs.host }}"
      run: |
        task -d $TEST_SCENARIOS_DIR/chart-full-setup setup.exec

    - name: Post setup
      timeout-minutes: 5
      run: |
        task -d $TEST_SCENARIOS_DIR/chart-full-setup setup.post
  
    - name: Pre Upgrade
      if: matrix.scenario.flow == 'upgrade'
      run: |
        task -d $TEST_SCENARIOS_DIR/chart-full-setup upgrade.pre
  
    - name: üåü Upgrade Camunda chart üåü
      if: matrix.scenario.flow == 'upgrade'
      env:
        TEST_HELM_EXTRA_ARGS: >-
          --set global.ingress.host=${{ steps.vars.outputs.ingress-host }}
          --values /tmp/extra-values-file.yaml
      run: |
        task -d $TEST_SCENARIOS_DIR/chart-full-setup upgrade.exec
  
    - name: Update GitHub deployment status
      uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8 # v1
      with:
        step: finish
        token: ${{ steps.generate-github-token.outputs.token }}
        status: ${{ job.status }}
        deployment_id: ${{ steps.deployment.outputs.deployment_id }}
        env_url: https://${{ steps.vars.outputs.ingress-host }}
        env: ${{ steps.vars.outputs.identifier }}
        ref: ${{ inputs.caller-git-ref }}
  
    - name: ‚≠êÔ∏è Run Preflight TestSuite ‚≠êÔ∏è
      if: inputs.test-enabled
      timeout-mioutputsnutes: 10
      run: |
        task -d $TEST_SCENARIOS_DIR/chart-full-setup test.preflight
  
    - name: ‚≠êÔ∏è Run Core TestSuite ‚≠êÔ∏è
      if: inputs.test-enabled
      timeout-minutes: 20
      run: |
        task -d $TEST_SCENARIOS_DIR/chart-full-setup test.core
  
    - name: üö® Get failed Pods info üö®
      if: failure()
      uses: ./.github/actions/failed-pods-info

    - name: Cleanup GitHub deployment
      if: always() && (env.TEST_PERSISTENT == 'false' || matrix.distro.type != 'kubernetes')
      uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8 # v1
      with:
        step: delete-env
        token: ${{ steps.generate-github-token.outputs.token }}
        env: ${{ steps.vars.outputs.identifier }}
        ref: ${{ inputs.caller-git-ref }}
  
    - name: Cleanup test namespace
      if: always() && (env.TEST_PERSISTENT == 'false' || matrix.distro.type != 'kubernetes')
      run: |
        kubectl delete ns --ignore-not-found=true \
          -l github-run-id=$GITHUB_WORKFLOW_RUN_ID \
          -l github-job-id=$GITHUB_WORKFLOW_JOB_ID

  clean:
    name: Clean up persistent resources
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      deployments: write
    steps:
    - uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4
    # Used to create/delete GitHub environment.
    # NOTE: The GH app requires "administration:write" access to be able to delete the GH environment.
    - name: Generate GitHub token
      uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2
      id: generate-github-token
      with:
        app_id: ${{ secrets.GH_APP_ID_DISTRO_CI_MANAGE_GH_ENVS }}
        private_key: ${{ secrets.GH_APP_PRIVATE_KEY_DISTRO_CI_MANAGE_GH_ENVS }}
    - name: Set PR vars
      id: vars
      uses: ./.github/actions/workflow-vars
      with:
        persistent: ${{ env.TEST_PERSISTENT }}
        platform: gke
        identifier-base: ${{ inputs.identifier }}
    # Persistent resources are deployed only on GKE.
    - name: Authenticate to GKE
      uses: ./.github/actions/gke-login
      with:
        cluster-name: ${{ secrets.DISTRO_CI_GCP_GKE_CLUSTER_NAME }}
        cluster-location: ${{ secrets.DISTRO_CI_GCP_GKE_CLUSTER_LOCATION }}
        workload-identity-provider: ${{ secrets.DISTRO_CI_GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service-account: ${{ secrets.DISTRO_CI_GCP_SERVICE_ACCOUNT }}
    - name: Cleanup GitHub deployment
      if: always()
      uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8 # v1
      with:
        step: delete-env
        token: ${{ steps.generate-github-token.outputs.token }}
        env: ${{ steps.vars.outputs.identifier }}
        ref: ${{ inputs.caller-git-ref }}
    - name: Cleanup test namespace
      if: always()
      run: |
        kubectl delete ns --ignore-not-found=true \
          -l "github-id=${{ steps.vars.outputs.identifier }},test-persistent=true"