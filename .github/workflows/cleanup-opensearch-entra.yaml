name: "Clean Up OpenSearch Indices and entra URIs"

on:
  schedule:
    # Set the cron schedule to run nightly at US time, EST (1AM UTC)
    - cron: "0 1 * * *"

permissions:
  contents: read
  id-token: write
  deployments: write

jobs:
  clean:
    name: Clean up Indices
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          repository: camunda/camunda-platform-helm
      - name: Configure curl and wget
        uses: ./.github/actions/setup-curl
      - name: Authenticate to GKE
        uses: ./.github/actions/gke-login
        with:
          cluster-name: ${{ secrets.DISTRO_CI_GCP_GKE_CLUSTER_NAME }}
          cluster-location: ${{ secrets.DISTRO_CI_GCP_GKE_CLUSTER_LOCATION }}
          workload-identity-provider: ${{ secrets.DISTRO_CI_GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service-account: ${{ secrets.DISTRO_CI_GCP_SERVICE_ACCOUNT }}
      - name: cleanup OpenSearch
        env:
          OPENSEARCH_BASIC_AUTH_BASE64: ${{ secrets.OPENSEARCH_BASIC_AUTH_BASE64 }}
        shell: bash
        run: |
          # OpenSearch endpoint
          OPENSEARCH_HOST="https://search-qa-e2e-5q5uium4w7pgfz7i5tviimmmgm.eu-north-1.es.amazonaws.com:443"

          # Get all namespace names
          ALL_NS=$(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n')

          # Extract 6-char hex job IDs from namespace names (new naming convention)
          # Namespaces end with -{hex} or -{hex}-upgp/-upgm
          HEX_PREFIXES=($(echo "$ALL_NS" | grep -oP '[a-f0-9]{6}(?=(-upgp|-upgm)?$)' || true))

          # Extract old-style trailing numeric run IDs for backward compatibility
          NUM_PREFIXES=($(echo "$ALL_NS" | grep -oP '\d+$' || true))

          # Combine, deduplicate, and add "." to protect OpenSearch system indices
          KEEP_PREFIXES=($(printf '%s\n' "${HEX_PREFIXES[@]}" "${NUM_PREFIXES[@]}" "." | sort -u))

          echo "prefixes to keep:"
          echo "${KEEP_PREFIXES[@]}"
          #Exclude prefixes from `KEEP_PREFIXES`array
          EXCLUSIONS=$(printf -- ",-%s*" "${KEEP_PREFIXES[@]}" | cut -c2-)
          curl -L -X DELETE ${OPENSEARCH_HOST}/*,${EXCLUSIONS} -H "Authorization: Basic $OPENSEARCH_BASIC_AUTH_BASE64"
      - name: update ISM policy
        env:
          OPENSEARCH_BASIC_AUTH_BASE64: ${{ secrets.OPENSEARCH_BASIC_AUTH_BASE64 }}
        shell: bash
        run: |
          OPENSEARCH_HOST="https://search-qa-e2e-5q5uium4w7pgfz7i5tviimmmgm.eu-north-1.es.amazonaws.com:443"
          # Update the delete-after-48h ISM policy to cover both old and new index naming patterns.
          # First, get current seq_no and primary_term (required for updating existing policies).
          POLICY_RESP=$(curl -s -L "${OPENSEARCH_HOST}/_plugins/_ism/policies/delete-after-48h" \
            -H "Authorization: Basic $OPENSEARCH_BASIC_AUTH_BASE64")
          SEQ_NO=$(echo "$POLICY_RESP" | jq -r '._seq_no // empty')
          PRIMARY_TERM=$(echo "$POLICY_RESP" | jq -r '._primary_term // empty')

          POLICY_BODY='{
            "policy": {
              "policy_id": "delete-after-48h",
              "description": "Delete indices after 24 hours",
              "default_state": "hot",
              "states": [
                {
                  "name": "hot",
                  "actions": [],
                  "transitions": [
                    {
                      "state_name": "delete",
                      "conditions": {
                        "min_index_age": "24h"
                      }
                    }
                  ]
                },
                {
                  "name": "delete",
                  "actions": [
                    {
                      "retry": {
                        "count": 3,
                        "backoff": "exponential",
                        "delay": "1m"
                      },
                      "delete": {}
                    }
                  ],
                  "transitions": []
                }
              ],
              "ism_template": [
                {
                  "index_patterns": ["*-qae2e-*", "*-install-*"],
                  "priority": 100
                }
              ]
            }
          }'

          if [[ -n "$SEQ_NO" && -n "$PRIMARY_TERM" ]]; then
            echo "Updating existing ISM policy (seq_no=$SEQ_NO, primary_term=$PRIMARY_TERM)..."
            curl -L -X PUT "${OPENSEARCH_HOST}/_plugins/_ism/policies/delete-after-48h?if_seq_no=${SEQ_NO}&if_primary_term=${PRIMARY_TERM}" \
              -H "Authorization: Basic $OPENSEARCH_BASIC_AUTH_BASE64" \
              -H "Content-Type: application/json" \
              -d "$POLICY_BODY" || echo "Warning: ISM policy update failed, skipping..."
          else
            echo "Creating new ISM policy..."
            curl -L -X PUT "${OPENSEARCH_HOST}/_plugins/_ism/policies/delete-after-48h" \
              -H "Authorization: Basic $OPENSEARCH_BASIC_AUTH_BASE64" \
              -H "Content-Type: application/json" \
              -d "$POLICY_BODY" || echo "Warning: ISM policy creation failed, skipping..."
          fi
      - name: cleanup Entra
        env: 
          ENTRA_PARENT_APP_DIRECTORY_ID: ${{ secrets.ENTRA_PARENT_APP_DIRECTORY_ID }}
          ENTRA_PARENT_APP_CLIENT_ID: ${{ secrets.ENTRA_PARENT_APP_CLIENT_ID }}
          ENTRA_PARENT_APP_CLIENT_SECRET: ${{ secrets.ENTRA_PARENT_APP_CLIENT_SECRET }}
          ENTRA_CHILD_APP_OBJECT_ID: ${{ secrets.ENTRA_CHILD_APP_OBJECT_ID }}
        shell: bash
        run: |
          RESPONSE=$(curl -X POST \
            https://login.microsoftonline.com/${ENTRA_PARENT_APP_DIRECTORY_ID}/oauth2/v2.0/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${ENTRA_PARENT_APP_CLIENT_ID}" \
            -d "scope=https://graph.microsoft.com/.default" \
            -d "client_secret=${ENTRA_PARENT_APP_CLIENT_SECRET}" \
            -d "grant_type=client_credentials")

          BEARER_TOKEN=$(echo "$RESPONSE" | jq -r ".access_token")

          curl -X PATCH \
          "https://graph.microsoft.com/v1.0/applications/${ENTRA_CHILD_APP_OBJECT_ID}" \
          -H "Authorization: Bearer ${BEARER_TOKEN}" \
          -H 'Content-Type: application/json' \
          -d '{
            "web": {
              "redirectUris": [
                "https://cleanup",
              ]
            },
            "spa": {
              "redirectUris": [
                "https://cleanup",
              ]
            }
          }'

