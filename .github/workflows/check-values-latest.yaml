name: Check values-latest.yaml

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  pull_request:
    paths:
      - 'charts/camunda-platform-*/values-latest.yaml'
      - 'scripts/check-values-latest.sh'
      - '.github/workflows/check-values-latest.yaml'
  workflow_dispatch:
    inputs:
      chart-version:
        description: 'Specific chart version to check (e.g., 8.7), leave empty for all'
        required: false
        default: ''
        type: string

permissions:
  contents: read

jobs:
  check-values-latest:
    name: Check values-latest.yaml files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 1

      - name: Install tools
        uses: ./.github/actions/install-tool-versions
        with:
          tools: |
            yq

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run validation script
        run: |
          set +e
          if [[ -n "${{ inputs.chart-version }}" ]]; then
            bash scripts/check-values-latest.sh "${{ inputs.chart-version }}"
          else
            bash scripts/check-values-latest.sh
          fi
          exit_code=$?
          
          echo "exit_code=${exit_code}" >> $GITHUB_OUTPUT
          exit ${exit_code}
        id: validation

      - name: Comment on PR (if validation failed)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **values-latest.yaml validation failed**\n\nSome image versions in `values-latest.yaml` files are not up-to-date with the latest releases. Please review the workflow logs for details.'
            })
