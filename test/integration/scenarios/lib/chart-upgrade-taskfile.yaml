version: '3'

vars:
  TEST_NAMESPACE: '{{ env "TEST_NAMESPACE" | default "camunda-platform" }}'
  TEST_CLUSTER_TYPE: '{{ env "TEST_CLUSTER_TYPE" | default "kubernetes" }}'
  TEST_HELM_EXTRA_ARGS: '{{ env "TEST_HELM_EXTRA_ARGS" }} {{ .TEST_OPENSHIFT_ARGS }}'

tasks:
  pre:
    cmds:
    - |
      test -f {{ .TEST_VALUES_BASE_DIR }}/pre-upgrade/* || {
        echo "No pre setup task for this test."
        exit 0
      }
      export TEST_NAMESPACE={{ .TEST_NAMESPACE }}
      bash -x {{ .TEST_VALUES_BASE_DIR }}/pre-upgrade/*.sh

  # https://docs.camunda.io/docs/self-managed/setup/upgrade/
  exec:
    cmds:
    - |
      helm upgrade integration {{ .TEST_CHART_NAME }} \
        --namespace {{ .TEST_NAMESPACE }} \
        --values {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml \
        --timeout 20m0s \
        --wait {{ .TEST_HELM_EXTRA_ARGS }}
  
  downgrade:
    cmds:
    - |
      # Iterate over each entry in downgrade-matrix.yaml and call helm upgrade for each
      yq -r '.downgrade[] | to_entries[] | "\(.key)=\(.value)"' {{ .TEST_VALUES_BASE_DIR }}/common/downgrade-matrix.yaml | while IFS== read -r comp tag; do
        if helm upgrade integration {{ .TEST_CHART_NAME }} \
          --namespace {{ .TEST_NAMESPACE }} \
          --values {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml \
          --set "$comp.$tag" \
          --timeout 2m0s \
          --dry-run=server \
          --wait {{ .TEST_HELM_EXTRA_ARGS }}; then
            echo "ERROR: Helm upgrade succeeded, but failure was expected for $comp.$tag"
            exit 1
        else
            echo "Helm upgrade failed as expected for $comp.$tag"
        fi
      done
