version: '3'

vars:
  TEST_NAMESPACE: '{{ env "TEST_NAMESPACE" | default "camunda-platform" }}'
  TEST_CLUSTER_TYPE: '{{ env "TEST_CLUSTER_TYPE" | default "kubernetes" }}'
  TEST_HELM_EXTRA_ARGS: '{{ env "TEST_HELM_EXTRA_ARGS" }} {{ .TEST_OPENSHIFT_ARGS }}'

tasks:
  pre:
    cmds:
    - |
      test -f {{ .TEST_VALUES_BASE_DIR }}/pre-upgrade/* || {
        echo "No pre setup task for this test."
        exit 0
      }
      export TEST_NAMESPACE={{ .TEST_NAMESPACE }}
      bash -x {{ .TEST_VALUES_BASE_DIR }}/pre-upgrade/*.sh

  # https://docs.camunda.io/docs/self-managed/setup/upgrade/
  exec:
    cmds:
    - |
      set +e -x
      # if the upgrade is from 8.4 -> 8.5, we need to add --force
      FORCE=""
      helm history -n {{ .TEST_NAMESPACE }} -o json integration | jq '.[].app_version' | grep 8.4
      if [ $? -eq 0 ]; then
        helm show chart {{ .TEST_CHART_NAME }} | yq .appVersion | grep 8.5
        if [ $? -eq 0 ]; then
          old_password="$(kubectl get -n {{ .TEST_NAMESPACE }} secret integration-postgresql -o yaml | yq .data.postgres-password | base64 -d | xargs echo)"
          new_password="$(kubectl get -n {{ .TEST_NAMESPACE }} secret integration-test-credentials -o yaml | yq .data.webmodeler-postgresql-user-password | base64 -d | xargs echo)"
          kubectl exec -n {{ .TEST_NAMESPACE }} integration-postgresql-web-modeler-0 -- env PGPASSWORD=$old_password psql -U web-modeler -c "ALTER USER \"web-modeler\" WITH PASSWORD '$new_password';"

          kubectl delete deployment -n {{ .TEST_NAMESPACE }} integration-identity
          kubectl wait -n {{ .TEST_NAMESPACE }} --for='delete' deployment/integration-identity
          FORCE="--force --install --set=global.postgresql.auth.existingSecret=integration-test-credentials"
        fi
      fi
      set -e +x

      helm upgrade integration {{ .TEST_CHART_NAME }} \
        --namespace {{ .TEST_NAMESPACE }} \
        --values {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml \
        --timeout 20m0s \
        --wait {{ .TEST_HELM_EXTRA_ARGS }}
