version: '3'

vars:
  TEST_NAMESPACE: '{{ env "TEST_NAMESPACE" }}'
  TEST_CLUSTER_TYPE: '{{ env "TEST_CLUSTER_TYPE" | default "kubernetes" }}'
  TEST_HELM_EXTRA_ARGS: '{{ env "TEST_HELM_EXTRA_ARGS" }} {{ .TEST_OPENSHIFT_ARGS }}'
  INFRA_TYPE_SUFFIX: '{{ eq (env "PLATFORM") "eks" | ternary ("eks") "" }}-{{ .INFRA_TYPE }}'

tasks:
  pre:
    env:
      # Needed for sub scripts.
      TEST_VALUES_BASE_DIR: "{{ .TEST_VALUES_BASE_DIR }}"
      TEST_NAMESPACE: "{{ .TEST_NAMESPACE }}"
    cmds:
    - |
      echo "TEST_CHART_FLOW: {{ .TEST_CHART_FLOW }}"
    - |
      {{ if eq .TEST_CHART_FLOW "upgrade-patch" }}
        # Pre-run scripts in the upgrade flow.
        bash -x {{ .TEST_VALUES_BASE_DIR }}/pre-setup-scripts/pre-upgrade-patch.sh
      {{ end }}
    - |
      {{ if eq .TEST_CHART_FLOW "upgrade-minor" }}
        # Pre-run scripts in the upgrade-minor flow.
        bash -x {{ .TEST_VALUES_BASE_DIR }}/pre-setup-scripts/pre-upgrade-minor.sh
      {{ end }}

  # https://docs.camunda.io/docs/self-managed/setup/upgrade/
  exec:
    cmds:
    - |
      {{ if eq .TEST_VALUES_SCENARIO "oidc" || eq .TEST_VALUES_SCENARIO "oidc-multi" }}
      export ENTRA_APP_CLIENT_ID={{ .ENTRA_APP_CLIENT_ID }}
      export ENTRA_APP_CLIENT_SECRET={{ .ENTRA_APP_CLIENT_SECRET }}
      export ENTRA_APP_DIRECTORY_ID={{ .ENTRA_APP_DIRECTORY_ID }}
      export ENTRA_APP_OBJECT_ID={{ .ENTRA_APP_OBJECT_ID }}

      export ENTRA_CONSOLE_CLIENT_ID={{ .ENTRA_CONSOLE_CLIENT_ID }}
      export ENTRA_CONSOLE_CLIENT_SECRET={{ .ENTRA_CONSOLE_CLIENT_SECRET }}
      export ENTRA_CONSOLE_DIRECTORY_ID={{ .ENTRA_CONSOLE_DIRECTORY_ID }}
      export ENTRA_CONSOLE_OBJECT_ID={{ .ENTRA_CONSOLE_OBJECT_ID }}

      export ENTRA_CONNECTORS_CLIENT_ID={{ .ENTRA_CONNECTORS_CLIENT_ID }}
      export ENTRA_CONNECTORS_CLIENT_SECRET={{ .ENTRA_CONNECTORS_CLIENT_SECRET }}
      export ENTRA_CONNECTORS_DIRECTORY_ID={{ .ENTRA_CONNECTORS_DIRECTORY_ID }}
      export ENTRA_CONNECTORS_OBJECT_ID={{ .ENTRA_CONNECTORS_OBJECT_ID }}

      export ENTRA_IDENTITY_CLIENT_ID={{ .ENTRA_IDENTITY_CLIENT_ID }}
      export ENTRA_IDENTITY_CLIENT_SECRET={{ .ENTRA_IDENTITY_CLIENT_SECRET }}
      export ENTRA_IDENTITY_DIRECTORY_ID={{ .ENTRA_IDENTITY_DIRECTORY_ID }}
      export ENTRA_IDENTITY_OBJECT_ID={{ .ENTRA_IDENTITY_OBJECT_ID }}

      export ENTRA_OPTIMIZE_CLIENT_ID={{ .ENTRA_OPTIMIZE_CLIENT_ID }}
      export ENTRA_OPTIMIZE_CLIENT_SECRET={{ .ENTRA_OPTIMIZE_CLIENT_SECRET }}
      export ENTRA_OPTIMIZE_DIRECTORY_ID={{ .ENTRA_OPTIMIZE_DIRECTORY_ID }}
      export ENTRA_OPTIMIZE_OBJECT_ID={{ .ENTRA_OPTIMIZE_OBJECT_ID }}

      export ENTRA_OPERATE_CLIENT_ID={{ .ENTRA_OPERATE_CLIENT_ID }}
      export ENTRA_OPERATE_CLIENT_SECRET={{ .ENTRA_OPERATE_CLIENT_SECRET }}
      export ENTRA_OPERATE_DIRECTORY_ID={{ .ENTRA_OPERATE_DIRECTORY_ID }}
      export ENTRA_OPERATE_OBJECT_ID={{ .ENTRA_OPERATE_OBJECT_ID }}

      export ENTRA_TASKLIST_CLIENT_ID={{ .ENTRA_TASKLIST_CLIENT_ID }}
      export ENTRA_TASKLIST_CLIENT_SECRET={{ .ENTRA_TASKLIST_CLIENT_SECRET }}
      export ENTRA_TASKLIST_DIRECTORY_ID={{ .ENTRA_TASKLIST_DIRECTORY_ID }}
      export ENTRA_TASKLIST_OBJECT_ID={{ .ENTRA_TASKLIST_OBJECT_ID }}

      export ENTRA_WEB_MODELER_CLIENT_ID={{ .ENTRA_WEB_MODELER_CLIENT_ID }}
      export ENTRA_WEB_MODELER_CLIENT_SECRET={{ .ENTRA_WEB_MODELER_CLIENT_SECRET }}
      export ENTRA_WEB_MODELER_DIRECTORY_ID={{ .ENTRA_WEB_MODELER_DIRECTORY_ID }}
      export ENTRA_WEB_MODELER_OBJECT_ID={{ .ENTRA_WEB_MODELER_OBJECT_ID }}

      export ENTRA_ORCHESTRATION_CLIENT_ID={{ .ENTRA_ORCHESTRATION_CLIENT_ID }}
      export ENTRA_ORCHESTRATION_CLIENT_SECRET={{ .ENTRA_ORCHESTRATION_CLIENT_SECRET }}
      export ENTRA_ORCHESTRATION_DIRECTORY_ID={{ .ENTRA_ORCHESTRATION_DIRECTORY_ID }}
      export ENTRA_ORCHESTRATION_OBJECT_ID={{ .ENTRA_ORCHESTRATION_OBJECT_ID }}

      envsubst < {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-{{ .TEST_VALUES_SCENARIO }}.yaml > {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-{{ .TEST_VALUES_SCENARIO }}.yaml.tmp
      mv {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-{{ .TEST_VALUES_SCENARIO }}.yaml.tmp {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-{{ .TEST_VALUES_SCENARIO }}.yaml
      cat {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-{{ .TEST_VALUES_SCENARIO }}.yaml
      {{ end }}

      if [[ -f {{ .TEST_VALUES_BASE_DIR }}/highest_client_id.awk ]]; then
        VENOM_KEYCLOAK_CLIENT_NUMBER="$(helm template integration {{ .TEST_CHART_NAME }} \
          --namespace {{ .TEST_NAMESPACE }} \
          --values {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-{{ .TEST_AUTH_TYPE }}.yaml \
          {{ if (env "TEST_CHART_VERSION" | hasPrefix "13") -}}
          --values {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-enable-migrator.yaml \
          {{ end -}}
          --values {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-{{ .TEST_VALUES_SCENARIO }}.yaml \
          --values {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml \
          --values {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test-pull-secrets.yaml \
          {{ if eq .PLATFORM "eks" -}}
          --values {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-infra.yaml \
          {{ end -}}
          {{ if not (empty .TEST_HELM_DIGEST_VALUES) -}}
          --values {{ .TEST_HELM_DIGEST_VALUES }} \
          {{ end -}}
          --values {{ .TEST_VALUES_BASE_DIR }}/infra/values-infra{{ .INFRA_TYPE_SUFFIX }}.yaml | awk -f {{ .TEST_VALUES_BASE_DIR }}/highest_client_id.awk -)"
  
        sed -i "s/KEYCLOAK_CLIENTS_[0-9]*/$VENOM_KEYCLOAK_CLIENT_NUMBER/" {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml
      fi

      helm upgrade integration {{ .TEST_CHART_NAME }} \
        --namespace {{ .TEST_NAMESPACE }} \
        --values {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml \
        --values {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test-pull-secrets.yaml \
        --values {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-{{ .TEST_AUTH_TYPE }}.yaml \
        {{ if (env "TEST_CHART_VERSION" | hasPrefix "13") -}}
        --values {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-enable-migrator.yaml \
        {{ end -}}
        --values {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-{{ .TEST_VALUES_SCENARIO }}.yaml \
        {{ if eq .PLATFORM "eks" -}}
        --values {{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values-integration-test-ingress-infra.yaml \
        {{ end -}}
        {{ if not (empty .TEST_HELM_DIGEST_VALUES) -}}
        --values {{ .TEST_HELM_DIGEST_VALUES }} \
        {{ end -}}
        --values {{ .TEST_VALUES_BASE_DIR }}/infra/values-infra{{ .INFRA_TYPE_SUFFIX }}.yaml \
        --force \
        --timeout 20m0s \
        --set orchestration.upgrade.allowPreReleaseImages=true \
        --force \
        --wait-for-jobs \
        --wait {{ .TEST_HELM_EXTRA_ARGS }} 
