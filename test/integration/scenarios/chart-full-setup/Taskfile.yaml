version: '3'

vars:
  TEST_NAMESPACE: '{{ env "TEST_NAMESPACE" | default "camunda-platform" }}'
  TEST_CLUSTER_TYPE: '{{ env "TEST_CLUSTER_TYPE" | default "kubernetes" }}'
  TEST_HELM_EXTRA_ARGS: '{{ env "TEST_HELM_EXTRA_ARGS" }} {{ .TEST_OPENSHIFT_ARGS }}'
  TEST_CHART_VERSION: '{{ env "TEST_CHART_VERSION" | default ">0.0.0" | quote }}'
  VALUES_CONFIG: '{{ env "VALUES_CONFIG" | default "{}" }}'
  INFRA_TYPE_SUFFIX: '{{ if eq (env "PLATFORM") "eks" }}eks-{{ end }}{{ .INFRA_TYPE }}'
  # Selection + composition model configuration
  # This is now the default approach (layered values with identity/persistence/platform/features)
  USE_LAYERED_VALUES: '{{ env "USE_LAYERED_VALUES" | default "true" }}'
  # Values directory (per chart version)
  LAYERED_VALUES_DIR: '{{ .TEST_VALUES_BASE_DIR }}/chart-full-setup/values'

dotenv:
- ../vars/common.env
- ../vars/dynamic.env
- ../vars/{{ .TEST_CLUSTER_TYPE }}.env

includes:
  init.seed:
    taskfile: ../lib/init-seed-taskfile.yaml
    internal: false
  upgrade:
    taskfile: ../lib/chart-upgrade-taskfile.yaml
    internal: true
    vars:
      TEST_NAMESPACE: "{{ .TEST_NAMESPACE }}"
      TEST_CLUSTER_TYPE: "{{ .TEST_CLUSTER_TYPE }}"
      TEST_HELM_EXTRA_ARGS: "{{ .TEST_HELM_EXTRA_ARGS }}"
  test.preflight:
    taskfile: ../lib/testsuite-deploy-taskfile.yaml
    vars:
      testID: preflight
      chartDir: "{{ .TEST_CHART_DIR }}"
  test.core:
    taskfile: ../lib/testsuite-deploy-taskfile.yaml
    vars:
      testID: core
      chartDir: "{{ .TEST_CHART_DIR }}"
  test.playwright.core:
    taskfile: ../lib/testsuite-deploy-taskfile-playwright.yaml
    vars:
      testID: playwright.core
      chartDir: "{{ .TEST_CHART_DIR }}"

tasks:
  # =============================================================================
  # Selection + Composition Model
  # =============================================================================
  # Maps legacy TEST_AUTH_TYPE and TEST_VALUES_SCENARIO to the new structure
  # This provides backward compatibility while enabling the new selection + composition approach
  #
  # Usage (new way - selection + composition):
  #   TEST_IDENTITY=keycloak TEST_PERSISTENCE=elasticsearch TEST_PLATFORM=gke
  #   TEST_FEATURES=multitenancy,documentstore TEST_QA=true TEST_IMAGE_TAGS=true
  #
  # Usage (deprecated but still supported):
  #   TEST_VALUES_AUTH=keycloak TEST_VALUES_BACKEND=elasticsearch TEST_VALUES_FEATURES=rba,multitenancy
  #
  # Usage (legacy, still supported):
  #   TEST_AUTH_TYPE=keycloak TEST_VALUES_SCENARIO=qa-elasticsearch-rba
  # =============================================================================
  
  build-layered-values:
    desc: "Build helm values arguments from selection + composition configuration"
    internal: true
    cmds:
      - |
        # This script maps legacy vars to the new structure and outputs helm --values args
        
        VALUES_DIR="{{ .LAYERED_VALUES_DIR }}"
        VALUES_ARGS=""
        
        # Check if values directory exists for this chart version
        if [[ ! -d "$VALUES_DIR" ]]; then
          echo "WARNING: Values directory not found: $VALUES_DIR" >&2
          echo "Falling back to legacy values files" >&2
          exit 1
        fi
        
        # =============================================================================
        # Layer 1: Base (always included)
        # =============================================================================
        if [[ -f "$VALUES_DIR/base.yaml" ]]; then
          VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/base.yaml"
        fi
        
        # =============================================================================
        # Layer 2: Base modifiers (QA, Upgrade)
        # =============================================================================
        QA_MODE="${TEST_QA:-${TEST_VALUES_QA:-}}"
        if [[ -z "$QA_MODE" ]]; then
          [[ "${TEST_VALUES_SCENARIO:-}" == qa-* ]] && QA_MODE="true"
        fi
        if [[ "$QA_MODE" == "true" && -f "$VALUES_DIR/base-qa.yaml" ]]; then
          VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/base-qa.yaml"
        fi
        
        UPGRADE_MODE="${TEST_UPGRADE:-}"
        if [[ -z "$UPGRADE_MODE" ]]; then
          [[ "${TEST_VALUES_SCENARIO:-}" == *"-upg"* || "${TEST_VALUES_SCENARIO:-}" == *"upgrade"* ]] && UPGRADE_MODE="true"
        fi
        if [[ "$UPGRADE_MODE" == "true" && -f "$VALUES_DIR/base-upgrade.yaml" ]]; then
          VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/base-upgrade.yaml"
        fi
        
        # =============================================================================
        # Layer 3: Identity method
        # Map from TEST_IDENTITY or legacy TEST_VALUES_AUTH/TEST_AUTH_TYPE
        # =============================================================================
        IDENTITY="${TEST_IDENTITY:-${TEST_VALUES_AUTH:-${TEST_AUTH_TYPE:-keycloak}}}"
        
        # Handle legacy composite auth types
        case "$IDENTITY" in
          keycloak-mt)
            IDENTITY_FILE="keycloak-external"
            ;;
          keycloak-rba|keycloak-rdbms|keycloak-oracle-rdbms)
            IDENTITY_FILE="keycloak"
            ;;
          *)
            IDENTITY_FILE="$IDENTITY"
            ;;
        esac
        
        if [[ -f "$VALUES_DIR/identity/${IDENTITY_FILE}.yaml" ]]; then
          VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/identity/${IDENTITY_FILE}.yaml"
        else
          echo "WARNING: Identity file not found: $VALUES_DIR/identity/${IDENTITY_FILE}.yaml" >&2
        fi
        
        # =============================================================================
        # Layer 4: Persistence (elasticsearch, opensearch, rdbms, rdbms-oracle)
        # Derived from TEST_PERSISTENCE or legacy TEST_VALUES_BACKEND/TEST_VALUES_SCENARIO
        # =============================================================================
        PERSISTENCE="${TEST_PERSISTENCE:-${TEST_VALUES_BACKEND:-}}"
        
        # If not explicitly set, derive from scenario or features
        if [[ -z "$PERSISTENCE" ]]; then
          case "${TEST_VALUES_SCENARIO:-}" in
            *opensearch*)
              PERSISTENCE="opensearch"
              ;;
            *oracle-rdbms*|*rdbms-oracle*)
              PERSISTENCE="rdbms-oracle"
              ;;
            *rdbms*)
              PERSISTENCE="rdbms"
              ;;
            *)
              PERSISTENCE="elasticsearch"
              ;;
          esac
        fi
        
        if [[ -f "$VALUES_DIR/persistence/${PERSISTENCE}.yaml" ]]; then
          VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/persistence/${PERSISTENCE}.yaml"
        fi
        
        # =============================================================================
        # Layer 5: Platform (gke, eks, openshift)
        # =============================================================================
        PLATFORM_TYPE="${TEST_PLATFORM:-${TEST_VALUES_INFRA:-${PLATFORM:-gke}}}"
        
        if [[ -f "$VALUES_DIR/platform/${PLATFORM_TYPE}.yaml" ]]; then
          VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/platform/${PLATFORM_TYPE}.yaml"
        fi
        
        # =============================================================================
        # Layer 6: Features (can be multiple, comma-separated)
        # Derived from TEST_FEATURES or legacy TEST_VALUES_FEATURES/TEST_VALUES_SCENARIO
        # =============================================================================
        FEATURES="${TEST_FEATURES:-${TEST_VALUES_FEATURES:-}}"
        
        # If not explicitly set, derive from scenario and identity type
        if [[ -z "$FEATURES" ]]; then
          SCENARIO="${TEST_VALUES_SCENARIO:-}"
          
          # Derive features from scenario name
          [[ "$SCENARIO" == *"-mt"* || "$SCENARIO" == *"multitenancy"* || "$IDENTITY" == "keycloak-mt" ]] && FEATURES="$FEATURES,multitenancy"
          [[ "$SCENARIO" == *"-rba"* || "$IDENTITY" == "keycloak-rba" ]] && FEATURES="$FEATURES,rba"
          [[ "$SCENARIO" == *"document"* || "$SCENARIO" == *"documentstore"* ]] && FEATURES="$FEATURES,documentstore"
          
          # Remove leading comma
          FEATURES="${FEATURES#,}"
        fi
        
        # Add feature files
        IFS=',' read -ra FEATURE_ARRAY <<< "$FEATURES"
        for feature in "${FEATURE_ARRAY[@]}"; do
          feature=$(echo "$feature" | xargs)  # trim whitespace
          if [[ -n "$feature" && -f "$VALUES_DIR/features/${feature}.yaml" ]]; then
            VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/features/${feature}.yaml"
          fi
        done
        
        # =============================================================================
        # Layer 7: Image tags (if enabled)
        # =============================================================================
        IMAGE_TAGS="${TEST_IMAGE_TAGS:-}"
        if [[ "$IMAGE_TAGS" == "true" && -f "$VALUES_DIR/base-image-tags.yaml" ]]; then
          VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/base-image-tags.yaml"
        fi
        
        # Output the values args
        echo "$VALUES_ARGS"

  setup.pre:
    env:
      VARIABLES_ENV_FILE: "{{ .TEST_CHART_DIR }}/test/integration/testsuites/vars/files/variables.env"
      # Needed for sub scripts.
      TEST_VALUES_BASE_DIR: "{{ .TEST_VALUES_BASE_DIR }}"
      TEST_NAMESPACE: "{{ .TEST_NAMESPACE }}"
    cmds:
    # Set Venom vars.
    - |
      echo "VENOM_VAR_SKIP_TEST_INGRESS=false" >> "${VARIABLES_ENV_FILE}"
      echo "VENOM_VAR_TEST_INGRESS_HOST=${TEST_INGRESS_HOST}" >> "${VARIABLES_ENV_FILE}"
      echo "VENOM_VAR_SKIP_TEST_WEBMODELER=false" >> "${VARIABLES_ENV_FILE}"
      
      # Build layered values for merging
      VALUES_DIR="{{ .LAYERED_VALUES_DIR }}"
      VALUES_FILES=""
      
      # Layer 1: Base
      [[ -f "$VALUES_DIR/base.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/base.yaml"
      
      # Layer 2: Base modifiers (QA, Upgrade)
      QA_MODE="${TEST_QA:-${TEST_VALUES_QA:-}}"
      [[ -z "$QA_MODE" && "${TEST_VALUES_SCENARIO:-}" == qa-* ]] && QA_MODE="true"
      [[ "$QA_MODE" == "true" && -f "$VALUES_DIR/base-qa.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/base-qa.yaml"
      
      UPGRADE_MODE="${TEST_UPGRADE:-}"
      [[ -z "$UPGRADE_MODE" && ("${TEST_VALUES_SCENARIO:-}" == *"-upg"* || "${TEST_VALUES_SCENARIO:-}" == *"upgrade"*) ]] && UPGRADE_MODE="true"
      [[ "$UPGRADE_MODE" == "true" && -f "$VALUES_DIR/base-upgrade.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/base-upgrade.yaml"
      
      # Layer 3: Identity
      IDENTITY="${TEST_IDENTITY:-${TEST_VALUES_AUTH:-${TEST_AUTH_TYPE:-keycloak}}}"
      case "$IDENTITY" in
        keycloak-mt) IDENTITY_FILE="keycloak-external" ;;
        keycloak-rba|keycloak-rdbms|keycloak-oracle-rdbms) IDENTITY_FILE="keycloak" ;;
        *) IDENTITY_FILE="$IDENTITY" ;;
      esac
      [[ -f "$VALUES_DIR/identity/${IDENTITY_FILE}.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/identity/${IDENTITY_FILE}.yaml"
      
      # Layer 4: Persistence
      PERSISTENCE="${TEST_PERSISTENCE:-${TEST_VALUES_BACKEND:-}}"
      if [[ -z "$PERSISTENCE" ]]; then
        case "${TEST_VALUES_SCENARIO:-}" in
          *opensearch*) PERSISTENCE="opensearch" ;;
          *oracle-rdbms*|*rdbms-oracle*) PERSISTENCE="rdbms-oracle" ;;
          *rdbms*) PERSISTENCE="rdbms" ;;
          *) PERSISTENCE="elasticsearch" ;;
        esac
      fi
      [[ -f "$VALUES_DIR/persistence/${PERSISTENCE}.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/persistence/${PERSISTENCE}.yaml"
      
      # Layer 5: Platform
      PLATFORM_TYPE="${TEST_PLATFORM:-${TEST_VALUES_INFRA:-${PLATFORM:-gke}}}"
      [[ -f "$VALUES_DIR/platform/${PLATFORM_TYPE}.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/platform/${PLATFORM_TYPE}.yaml"
      
      # Layer 6: Features
      FEATURES="${TEST_FEATURES:-${TEST_VALUES_FEATURES:-}}"
      if [[ -z "$FEATURES" ]]; then
        SCENARIO="${TEST_VALUES_SCENARIO:-}"
        [[ "$SCENARIO" == *"-mt"* || "$SCENARIO" == *"multitenancy"* || "$IDENTITY" == "keycloak-mt" ]] && FEATURES="$FEATURES,multitenancy"
        [[ "$SCENARIO" == *"-rba"* || "$IDENTITY" == "keycloak-rba" ]] && FEATURES="$FEATURES,rba"
        [[ "$SCENARIO" == *"document"* ]] && FEATURES="$FEATURES,documentstore"
        FEATURES="${FEATURES#,}"
      fi
      IFS=',' read -ra FEATURE_ARRAY <<< "$FEATURES"
      for feature in "${FEATURE_ARRAY[@]}"; do
        feature=$(echo "$feature" | xargs)
        [[ -n "$feature" && -f "$VALUES_DIR/features/${feature}.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/features/${feature}.yaml"
      done
      
      # Layer 7: Image tags
      IMAGE_TAGS="${TEST_IMAGE_TAGS:-}"
      [[ "$IMAGE_TAGS" == "true" && -f "$VALUES_DIR/base-image-tags.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/base-image-tags.yaml"
      
      # Step 1: Merge all YAMLs
      MERGED_YAML=$(yq eval-all '. as $item ireduce ({}; . * $item )' \
        "{{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml" \
        $VALUES_FILES \
        "{{ .TEST_VALUES_BASE_DIR }}/infra/values-infra-{{ .INFRA_TYPE_SUFFIX }}.yaml" \
        /tmp/extra-values-file.yaml)
      
      echo "--- Merged YAML ---"
      echo "$MERGED_YAML"
      echo "-------------------"
      # Step 2: Extract the Elasticsearch enabled value
      ES_ENABLED=$(echo "$MERGED_YAML" | yq '.elasticsearch.enabled // false')
      
      echo "Elasticsearch enabled: $ES_ENABLED"

      # Step 3: Determine if we should skip test
      VENOM_VAR_SKIP_TEST_ELASTICSEARCH=$(echo "$ES_ENABLED" | yq 'not')
      
      echo "Skip Elasticsearch test: $VENOM_VAR_SKIP_TEST_ELASTICSEARCH"
      echo "VENOM_VAR_SKIP_TEST_ELASTICSEARCH=$VENOM_VAR_SKIP_TEST_ELASTICSEARCH" >> "$VARIABLES_ENV_FILE"
      echo "VENOM_VAR_SKIP_TEST_KEYCLOAK=$( [ "${PERSISTENCE:-elasticsearch}" = "elasticsearch" ] && [ "${IDENTITY:-keycloak}" = "keycloak" ] || echo false )" >> "${VARIABLES_ENV_FILE}"
      echo "VENOM_EXTRA_ARGS=--var-from-file=./vars/variables-ingress-combined.yaml" >> "${VARIABLES_ENV_FILE}"
      echo "ZEEBE_VERSION=$(yq '.zeebe.image.tag' {{ .TEST_CHART_DIR }}/values.yaml)" >> "${VARIABLES_ENV_FILE}"
      # In case the Zeebe version has not been released officially yet.
      echo "ZEEBE_VERSION_FALLBACK=$(grep zbctl ../../../../.tool-versions | cut -d " " -f 2)" >> "${VARIABLES_ENV_FILE}"
      cat "${VARIABLES_ENV_FILE}"
    - |
      {{ if eq .TEST_CHART_FLOW "upgrade-patch" }}
        # Extract OpenShift values from released chart for upgrade test.
        helm pull {{ .TEST_CHART_NAME }} --untar --untardir {{ .TEST_TMP_DIR }} \
          --version {{ .TEST_CHART_VERSION }}
        # Pre-run scripts in the upgrade flow.
        bash -x {{ .TEST_VALUES_BASE_DIR }}/pre-setup-scripts/pre-install-upgrade.sh
      {{ end }}
    - |
      {{ if eq .TEST_CHART_FLOW "install" }}
        # Pre-run scripts in the install flow.
        bash -x {{ .TEST_VALUES_BASE_DIR }}/pre-setup-scripts/pre-install.sh
      {{ end }}
    - |
      {{ if and (eq .TEST_PERSISTENCE "opensearch") .TEST_OPENSEARCH_PREFIX }}
        # Update OpenSearch prefix in the persistence file if needed
        sed -i 's/custom/{{ .TEST_OPENSEARCH_PREFIX }}/g' {{ .LAYERED_VALUES_DIR }}/persistence/opensearch.yaml
      {{ else if and (eq .TEST_VALUES_BACKEND "opensearch") .TEST_OPENSEARCH_PREFIX }}
        # Backward compatibility: Update OpenSearch prefix
        sed -i 's/custom/{{ .TEST_OPENSEARCH_PREFIX }}/g' {{ .LAYERED_VALUES_DIR }}/persistence/opensearch.yaml
      {{ end }}
    - |
      # Print out all the values that are being applied for debugging purposes.
      VALUES_DIR="{{ .LAYERED_VALUES_DIR }}"
      
      echo "Values being applied (selection + composition model):"
      echo "=========================================="
      
      echo "common/values-integration-test.yaml:"
      cat {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml
      echo ""
      
      echo "common/values-integration-test-pull-secrets.yaml:"
      cat {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test-pull-secrets.yaml
      echo ""
      
      echo "Values from: $VALUES_DIR"
      for f in "$VALUES_DIR"/*.yaml "$VALUES_DIR"/**/*.yaml; do
        [[ -f "$f" ]] && echo "  - $f"
      done
      echo ""
      
      {{ if and (eq .TEST_CHART_FLOW "install") (not (empty .TEST_HELM_DIGEST_VALUES)) -}}
        echo "helm-digest-values.yaml:"
        cat {{ .TEST_HELM_DIGEST_VALUES }}
        echo ""
      {{ end -}}

      echo "infra values:"
      cat {{ .INFRA_TYPE_VALUES }}
      echo ""

      echo "extra-values-file.yaml:"
      cat /tmp/extra-values-file.yaml
      echo ""
      
      echo "=========================================="

  setup.package:
    cmds:
    # Set Venom vars.
    - |
      # Create the local chart package to install.
      echo "ℹ️ Packaging chart from {{ .TEST_CHART_DIR }}"
      pwd
      rm -rf *.tgz
      helm package --dependency-update {{ .TEST_CHART_DIR }}/

  setup.venom.env:
    preconditions:
      - test -n "${TEST_INGRESS_HOST}"
    env:
      VARIABLES_ENV_FILE: "{{ .TEST_CHART_DIR }}/test/integration/testsuites/vars/files/variables.env"
    cmds:
      - |
        echo "VENOM_VAR_SKIP_TEST_INGRESS=false" >> "${VARIABLES_ENV_FILE}"
        echo "VENOM_VAR_TEST_INGRESS_HOST=${TEST_INGRESS_HOST}" >> "${VARIABLES_ENV_FILE}"
        echo "VENOM_VAR_SKIP_TEST_WEBMODELER=false" >> "${VARIABLES_ENV_FILE}"
        
        # Build values for merging using selection + composition model
        VALUES_DIR="{{ .LAYERED_VALUES_DIR }}"
        VALUES_FILES=""
        
        # Layer 1: Base
        [[ -f "$VALUES_DIR/base.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/base.yaml"
        
        # Layer 2: Base modifiers (QA, Upgrade)
        QA_MODE="${TEST_QA:-${TEST_VALUES_QA:-}}"
        [[ -z "$QA_MODE" && "${TEST_VALUES_SCENARIO:-}" == qa-* ]] && QA_MODE="true"
        [[ "$QA_MODE" == "true" && -f "$VALUES_DIR/base-qa.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/base-qa.yaml"
        
        # Layer 3: Identity
        IDENTITY="${TEST_IDENTITY:-${TEST_VALUES_AUTH:-${TEST_AUTH_TYPE:-keycloak}}}"
        case "$IDENTITY" in
          keycloak-mt) IDENTITY_FILE="keycloak-external" ;;
          keycloak-rba|keycloak-rdbms|keycloak-oracle-rdbms) IDENTITY_FILE="keycloak" ;;
          *) IDENTITY_FILE="$IDENTITY" ;;
        esac
        [[ -f "$VALUES_DIR/identity/${IDENTITY_FILE}.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/identity/${IDENTITY_FILE}.yaml"
        
        # Layer 4: Persistence
        PERSISTENCE="${TEST_PERSISTENCE:-${TEST_VALUES_BACKEND:-}}"
        if [[ -z "$PERSISTENCE" ]]; then
          case "${TEST_VALUES_SCENARIO:-}" in
            *opensearch*) PERSISTENCE="opensearch" ;;
            *oracle-rdbms*|*rdbms-oracle*) PERSISTENCE="rdbms-oracle" ;;
            *rdbms*) PERSISTENCE="rdbms" ;;
            *) PERSISTENCE="elasticsearch" ;;
          esac
        fi
        [[ -f "$VALUES_DIR/persistence/${PERSISTENCE}.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/persistence/${PERSISTENCE}.yaml"
        
        # Layer 5: Platform
        PLATFORM_TYPE="${TEST_PLATFORM:-${TEST_VALUES_INFRA:-${PLATFORM:-gke}}}"
        [[ -f "$VALUES_DIR/platform/${PLATFORM_TYPE}.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/platform/${PLATFORM_TYPE}.yaml"
        
        # Layer 6: Features (simplified for venom env)
        FEATURES="${TEST_FEATURES:-${TEST_VALUES_FEATURES:-}}"
        if [[ -z "$FEATURES" ]]; then
          SCENARIO="${TEST_VALUES_SCENARIO:-}"
          [[ "$SCENARIO" == *"-mt"* || "$SCENARIO" == *"multitenancy"* || "$IDENTITY" == "keycloak-mt" ]] && FEATURES="$FEATURES,multitenancy"
          [[ "$SCENARIO" == *"-rba"* || "$IDENTITY" == "keycloak-rba" ]] && FEATURES="$FEATURES,rba"
          [[ "$SCENARIO" == *"document"* ]] && FEATURES="$FEATURES,documentstore"
          FEATURES="${FEATURES#,}"
        fi
        IFS=',' read -ra FEATURE_ARRAY <<< "$FEATURES"
        for feature in "${FEATURE_ARRAY[@]}"; do
          feature=$(echo "$feature" | xargs)
          [[ -n "$feature" && -f "$VALUES_DIR/features/${feature}.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/features/${feature}.yaml"
        done
        
        # Layer 7: Image tags
        IMAGE_TAGS="${TEST_IMAGE_TAGS:-}"
        [[ "$IMAGE_TAGS" == "true" && -f "$VALUES_DIR/base-image-tags.yaml" ]] && VALUES_FILES="$VALUES_FILES $VALUES_DIR/base-image-tags.yaml"
        
        # Step 1: Merge all YAMLs
        MERGED_YAML=$(yq eval-all '. as $item ireduce ({}; . * $item )' \
          "{{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml" \
          $VALUES_FILES \
          "{{ .TEST_VALUES_BASE_DIR }}/infra/values-infra-{{ .INFRA_TYPE_SUFFIX }}.yaml" \
          /tmp/extra-values-file.yaml)
        
        echo "--- Merged YAML ---"
        echo "$MERGED_YAML"
        echo "-------------------"
        # Step 2: Extract the Elasticsearch enabled value
        ES_ENABLED=$(echo "$MERGED_YAML" | yq '.elasticsearch.enabled // false')
        
        echo "Elasticsearch enabled: $ES_ENABLED"
  
        # Step 3: Determine if we should skip test
        VENOM_VAR_SKIP_TEST_ELASTICSEARCH=$(echo "$ES_ENABLED" | yq 'not')
        
        echo "Skip Elasticsearch test: $VENOM_VAR_SKIP_TEST_ELASTICSEARCH"
        echo "VENOM_VAR_SKIP_TEST_ELASTICSEARCH=$VENOM_VAR_SKIP_TEST_ELASTICSEARCH" >> "$VARIABLES_ENV_FILE"
        echo "VENOM_EXTRA_ARGS=--var-from-file=./vars/variables-ingress-combined.yaml" >> "${VARIABLES_ENV_FILE}"
        echo "ZEEBE_VERSION=$(yq '.zeebe.image.tag' {{ .TEST_CHART_DIR }}/values.yaml)" >> "${VARIABLES_ENV_FILE}"
        # In case the Zeebe version has not been released officially yet.
        echo "ZEEBE_VERSION_FALLBACK=$(grep zbctl ../../../../.tool-versions | cut -d " " -f 2)" >> "${VARIABLES_ENV_FILE}"
        cat ${VARIABLES_ENV_FILE}

  # =============================================================================
  # setup.exec - Uses selection + composition model (default)
  # =============================================================================
  # This task now uses the selection + composition approach.
  # The old monolithic value files have been removed in favor of composable layers.
  #
  # Environment variables (new - preferred):
  #   TEST_IDENTITY    - Identity: keycloak, keycloak-external, oidc, basic, hybrid
  #   TEST_PERSISTENCE - Persistence: elasticsearch, opensearch, rdbms, rdbms-oracle
  #   TEST_PLATFORM    - Platform: gke, eks, openshift
  #   TEST_FEATURES    - Features (comma-separated): multitenancy, rba, documentstore
  #   TEST_QA          - Enable QA config: true/false
  #   TEST_IMAGE_TAGS  - Enable image tag overrides: true/false
  #   TEST_UPGRADE     - Enable upgrade flow: true/false
  #
  # Legacy variables (deprecated but still supported):
  #   TEST_VALUES_AUTH     - Maps to TEST_IDENTITY
  #   TEST_VALUES_BACKEND  - Maps to TEST_PERSISTENCE
  #   TEST_VALUES_FEATURES - Maps to TEST_FEATURES
  #   TEST_VALUES_QA       - Maps to TEST_QA
  #   TEST_VALUES_INFRA    - Maps to TEST_PLATFORM
  #   TEST_AUTH_TYPE       - Maps to TEST_IDENTITY
  #   TEST_VALUES_SCENARIO - Used to derive all settings
  # =============================================================================
  setup.exec:
    desc: "Install helm chart using selection + composition configuration"
    env:
      VARIABLES_ENV_FILE: "{{ .TEST_CHART_DIR }}/test/integration/testsuites/vars/files/variables.env"
    cmds:
    - |
      set -o pipefail
      
      VALUES_DIR="{{ .LAYERED_VALUES_DIR }}"
      
      # Check if values directory exists
      if [[ ! -d "$VALUES_DIR" ]]; then
        echo "ERROR: Values directory not found: $VALUES_DIR" >&2
        echo "Please ensure the values structure exists for this chart version" >&2
        exit 1
      fi
      
      # Build values arguments
      VALUES_ARGS=""
      
      # =============================================================================
      # Layer 1: Base (always included)
      # =============================================================================
      if [[ -f "$VALUES_DIR/base.yaml" ]]; then
        VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/base.yaml"
        echo "Layer 1 (base): $VALUES_DIR/base.yaml"
      fi
      
      # =============================================================================
      # Layer 2: Base modifiers (QA, Upgrade)
      # =============================================================================
      QA_MODE="${TEST_QA:-${TEST_VALUES_QA:-}}"
      if [[ -z "$QA_MODE" ]]; then
        [[ "${TEST_VALUES_SCENARIO:-}" == qa-* ]] && QA_MODE="true"
      fi
      if [[ "$QA_MODE" == "true" && -f "$VALUES_DIR/base-qa.yaml" ]]; then
        VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/base-qa.yaml"
        echo "Layer 2 (qa): $VALUES_DIR/base-qa.yaml"
      fi
      
      UPGRADE_MODE="${TEST_UPGRADE:-}"
      if [[ -z "$UPGRADE_MODE" ]]; then
        [[ "${TEST_VALUES_SCENARIO:-}" == *"-upg"* || "${TEST_VALUES_SCENARIO:-}" == *"upgrade"* ]] && UPGRADE_MODE="true"
      fi
      if [[ "$UPGRADE_MODE" == "true" && -f "$VALUES_DIR/base-upgrade.yaml" ]]; then
        VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/base-upgrade.yaml"
        echo "Layer 2 (upgrade): $VALUES_DIR/base-upgrade.yaml"
      fi
      
      # =============================================================================
      # Layer 3: Identity method
      # =============================================================================
      IDENTITY="${TEST_IDENTITY:-${TEST_VALUES_AUTH:-${TEST_AUTH_TYPE:-keycloak}}}"
      
      # Map legacy composite auth types
      case "$IDENTITY" in
        keycloak-mt)
          IDENTITY_FILE="keycloak-external"
          ;;
        keycloak-rba|keycloak-rdbms|keycloak-oracle-rdbms)
          IDENTITY_FILE="keycloak"
          ;;
        *)
          IDENTITY_FILE="$IDENTITY"
          ;;
      esac
      
      if [[ -f "$VALUES_DIR/identity/${IDENTITY_FILE}.yaml" ]]; then
        VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/identity/${IDENTITY_FILE}.yaml"
        echo "Layer 3 (identity): $VALUES_DIR/identity/${IDENTITY_FILE}.yaml"
      else
        echo "WARNING: Identity file not found: $VALUES_DIR/identity/${IDENTITY_FILE}.yaml" >&2
      fi
      
      # =============================================================================
      # Layer 4: Persistence
      # =============================================================================
      PERSISTENCE="${TEST_PERSISTENCE:-${TEST_VALUES_BACKEND:-}}"
      
      if [[ -z "$PERSISTENCE" ]]; then
        case "${TEST_VALUES_SCENARIO:-}" in
          *opensearch*)
            PERSISTENCE="opensearch"
            ;;
          *oracle-rdbms*|*rdbms-oracle*)
            PERSISTENCE="rdbms-oracle"
            ;;
          *rdbms*)
            PERSISTENCE="rdbms"
            ;;
          *)
            PERSISTENCE="elasticsearch"
            ;;
        esac
      fi
      
      if [[ -f "$VALUES_DIR/persistence/${PERSISTENCE}.yaml" ]]; then
        VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/persistence/${PERSISTENCE}.yaml"
        echo "Layer 4 (persistence): $VALUES_DIR/persistence/${PERSISTENCE}.yaml"
      fi
      
      # =============================================================================
      # Layer 5: Platform
      # =============================================================================
      PLATFORM_TYPE="${TEST_PLATFORM:-${TEST_VALUES_INFRA:-${PLATFORM:-gke}}}"
      
      if [[ -f "$VALUES_DIR/platform/${PLATFORM_TYPE}.yaml" ]]; then
        VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/platform/${PLATFORM_TYPE}.yaml"
        echo "Layer 5 (platform): $VALUES_DIR/platform/${PLATFORM_TYPE}.yaml"
      fi
      
      # =============================================================================
      # Layer 6: Features
      # =============================================================================
      FEATURES="${TEST_FEATURES:-${TEST_VALUES_FEATURES:-}}"
      
      if [[ -z "$FEATURES" ]]; then
        SCENARIO="${TEST_VALUES_SCENARIO:-}"
        
        # Derive features from scenario name
        [[ "$SCENARIO" == *"-mt"* || "$SCENARIO" == *"multitenancy"* || "$IDENTITY" == "keycloak-mt" ]] && FEATURES="$FEATURES,multitenancy"
        [[ "$SCENARIO" == *"-rba"* || "$IDENTITY" == "keycloak-rba" ]] && FEATURES="$FEATURES,rba"
        [[ "$SCENARIO" == *"document"* || "$SCENARIO" == *"documentstore"* ]] && FEATURES="$FEATURES,documentstore"
        
        FEATURES="${FEATURES#,}"
      fi
      
      IFS=',' read -ra FEATURE_ARRAY <<< "$FEATURES"
      for feature in "${FEATURE_ARRAY[@]}"; do
        feature=$(echo "$feature" | xargs)
        if [[ -n "$feature" && -f "$VALUES_DIR/features/${feature}.yaml" ]]; then
          VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/features/${feature}.yaml"
          echo "Layer 6 (feature): $VALUES_DIR/features/${feature}.yaml"
        fi
      done
      
      # =============================================================================
      # Layer 7: Image tags (if enabled)
      # =============================================================================
      IMAGE_TAGS="${TEST_IMAGE_TAGS:-}"
      IMAGE_TAGS_ARGS=""
      
      if [[ "$IMAGE_TAGS" == "true" && -f "$VALUES_DIR/base-image-tags.yaml" ]]; then
        VALUES_ARGS="$VALUES_ARGS --values $VALUES_DIR/base-image-tags.yaml"
        echo "Layer 7 (image-tags): $VALUES_DIR/base-image-tags.yaml"
      elif [[ -f /tmp/values-image-tags-processed.yaml ]]; then
        IMAGE_TAGS_ARGS="--values /tmp/values-image-tags-processed.yaml"
        echo "Including processed image tags file"
      fi
      
      echo ""
      echo "=========================================="
      echo "Final helm install command:"
      echo "=========================================="
      
      helm install integration {{ .TEST_CHART_NAME }} \
        --version {{ .TEST_CHART_VERSION }} \
        --namespace {{ .TEST_NAMESPACE }} \
        --values {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test.yaml \
        --values {{ .TEST_VALUES_BASE_DIR }}/common/values-integration-test-pull-secrets.yaml \
        $VALUES_ARGS \
        {{ if and (eq .TEST_CHART_FLOW "install") (not (empty .TEST_HELM_DIGEST_VALUES)) -}}
        --values {{ .TEST_HELM_DIGEST_VALUES }} \
        {{ end -}}
        --values {{ .TEST_VALUES_BASE_DIR }}/infra/values-infra-{{ .INFRA_TYPE_SUFFIX }}.yaml \
        $IMAGE_TAGS_ARGS \
        --values /tmp/extra-values-file.yaml \
        --timeout 20m0s \
        --wait \
        --wait-for-jobs \
        {{ .TEST_HELM_EXTRA_ARGS }} |& grep -v 'Ignoring non-table value'

  # =============================================================================
  # DEPRECATED: setup.exec.layered - Now same as setup.exec
  # =============================================================================
  # Kept for backward compatibility. Use setup.exec instead.
  # =============================================================================
  setup.exec.layered:
    desc: "DEPRECATED: Use setup.exec instead. Install helm chart using layered values configuration"
    env:
      VARIABLES_ENV_FILE: "{{ .TEST_CHART_DIR }}/test/integration/testsuites/vars/files/variables.env"
    cmds:
    - task: setup.exec

  setup.post:
    env:
      TEST_VALUES_BASE_DIR: "{{ .TEST_VALUES_BASE_DIR }}"
    cmds:
    - |
      if [ "{{ .TEST_VALUES_SCENARIO }}" = "gateway-keycloak" ]; then
        echo "Applying post-deploy resources for gateway-keycloak scenario"
        RESOURCES_DIR="{{ .TEST_VALUES_BASE_DIR }}/common/resources"
        if [ -d "$RESOURCES_DIR" ]; then
          for f in "$RESOURCES_DIR"/*.yaml "$RESOURCES_DIR"/*.yml; do
            [ -f "$f" ] || continue
            echo "Applying resource: $f"
            export NAMESPACE="{{ .TEST_NAMESPACE }}"
            export RELEASE_NAME="integration"
            envsubst '$NAMESPACE $RELEASE_NAME' < "$f" | kubectl apply -f -
          done
        else
          echo "Resources directory not found: $RESOURCES_DIR"
        fi
      else
        echo "No post task for this test."
      fi

  setup.clean:
    cmds:
    - kubectl delete secret registry-camunda-cloud --ignore-not-found=true
    - git checkout {{ .TEST_CHART_DIR }}/test/integration/testsuites/vars/files/variables.env

  entra.update-redirect-uris:
    desc: "Update Entra application redirect URIs for current TEST_INGRESS_HOST"
    preconditions:
      - test -n "{{ .TEST_INGRESS_HOST }}"
      - test -n "{{ .ENTRA_APP_DIRECTORY_ID }}"
      - test -n "{{ .ENTRA_APP_CLIENT_ID }}"
      - test -n "{{ .ENTRA_APP_CLIENT_SECRET }}"
      - test -n "{{ .ENTRA_APP_OBJECT_ID }}"
    cmds:
      - |
        RESPONSE=$(curl -s -X POST \
          https://login.microsoftonline.com/{{ .ENTRA_APP_DIRECTORY_ID }}/oauth2/v2.0/token \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "client_id={{ .ENTRA_APP_CLIENT_ID }}" \
          -d "scope=https://graph.microsoft.com/.default" \
          -d "client_secret={{ .ENTRA_APP_CLIENT_SECRET }}" \
          -d "grant_type=client_credentials")

        BEARER_TOKEN=$(echo "$RESPONSE" | jq -r ".access_token")
        if [ -z "$BEARER_TOKEN" ] || [ "$BEARER_TOKEN" = "null" ]; then
          echo "Failed to obtain Entra bearer token" >&2
          echo "$RESPONSE" >&2
          exit 1
        fi

        NEW_WEB_URIS=(
          "https://{{ .TEST_INGRESS_HOST }}/identity/auth/login-callback"
          "https://{{ .TEST_INGRESS_HOST }}/operate/identity-callback"
          "https://{{ .TEST_INGRESS_HOST }}/optimize/api/authentication/callback"
          "https://{{ .TEST_INGRESS_HOST }}/tasklist/identity-callback"
          "https://{{ .TEST_INGRESS_HOST }}/orchestration/sso-callback"
        )
        NEW_SPA_URIS=(
          "https://{{ .TEST_INGRESS_HOST }}/modeler/login-callback"
          "https://{{ .TEST_INGRESS_HOST }}/"
        )

        APP_JSON=$(curl -s -X GET \
          "https://graph.microsoft.com/v1.0/applications/{{ .ENTRA_APP_OBJECT_ID }}" \
          -H "Authorization: Bearer ${BEARER_TOKEN}" \
          -H "Content-Type: application/json")

        WEB_URIS=$(echo "$APP_JSON" | jq -r '.web.redirectUris[]?' || true)
        SPA_URIS=$(echo "$APP_JSON" | jq -r '.spa.redirectUris[]?' || true)

        ALL_WEB_URIS=("${WEB_URIS[@]}" "${NEW_WEB_URIS[@]}")
        ALL_SPA_URIS=("${SPA_URIS[@]}" "${NEW_SPA_URIS[@]}")

        FINAL_WEB_URIS=$(printf "%s\n" "${ALL_WEB_URIS[@]}" | sed '/^$/d' | sort -u | jq -R . | jq -s .)
        FINAL_SPA_URIS=$(printf "%s\n" "${ALL_SPA_URIS[@]}" | sed '/^$/d' | sort -u | jq -R . | jq -s .)

        echo "web URIs:"
        echo $FINAL_WEB_URIS
        echo "SPA URIs:"
        echo $FINAL_SPA_URIS

        curl -s -X PATCH \
          "https://graph.microsoft.com/v1.0/applications/{{ .ENTRA_APP_OBJECT_ID }}" \
          -H "Authorization: Bearer ${BEARER_TOKEN}" \
          -H "Content-Type: application/json" \
          -d "{
            \"web\": { \"redirectUris\": $FINAL_WEB_URIS },
            \"spa\": { \"redirectUris\": $FINAL_SPA_URIS }
          }" | cat

  entra.template-yaml:
    desc: "Template Entra configuration into OIDC identity file"
    cmds:
      - |
        export ENTRA_APP_CLIENT_ID={{ .ENTRA_APP_CLIENT_ID }}
        export ENTRA_APP_CLIENT_SECRET={{ .ENTRA_APP_CLIENT_SECRET }}
        export ENTRA_APP_DIRECTORY_ID={{ .ENTRA_APP_DIRECTORY_ID }}
        export ENTRA_APP_OBJECT_ID={{ .ENTRA_APP_OBJECT_ID }}

        # Template the OIDC identity file for Entra
        OIDC_FILE="{{ .LAYERED_VALUES_DIR }}/identity/oidc.yaml"
        if [[ -f "$OIDC_FILE" ]]; then
          envsubst < "$OIDC_FILE" > "${OIDC_FILE}.tmp"
          mv "${OIDC_FILE}.tmp" "$OIDC_FILE"
          cat "$OIDC_FILE"
        else
          echo "WARNING: OIDC identity file not found: $OIDC_FILE" >&2
        fi

  upgrade.pre:
    deps: [upgrade:pre]

  upgrade.exec:
    deps: [upgrade:exec]

  all:
    desc: "Run full test flow using selection + composition configuration"
    cmds:
    - task: init.seed
    - task: setup.pre
    - task: setup.exec
    - task: setup.post
    - task: test.preflight
    - task: test.core
    - task: test.playwright.core

  # DEPRECATED: Kept for backward compatibility, same as 'all'
  all.layered:
    desc: "DEPRECATED: Use 'all' instead. Run full test flow using selection + composition configuration"
    cmds:
    - task: all
