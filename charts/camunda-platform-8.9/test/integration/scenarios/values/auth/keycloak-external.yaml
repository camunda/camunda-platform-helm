# External/Shared Keycloak authentication
# Layer 2: Auth method
# Used when TEST_AUTH=keycloak-external
# Also used by: keycloak-original, keycloak-external-mimic, keycloak-mt

global:
  annotations:
    keycloak-token-url: "$KEYCLOAK_EXT_PROTOCOL_24_9_0://$KEYCLOAK_EXT_HOST_24_9_0/auth/realms/$KEYCLOAK_REALM/protocol/openid-connect/token"
  elasticsearch:
    external: true
    prefix: $ORCHESTRATION_INDEX_PREFIX-$FLOW
    auth:
      username: elastic
      secret:
        existingSecret: infra-credentials
        existingSecretKey: elasticsearch-password
    url:
      protocol: https
      host: elasticsearch-21-6-3.ci.distro.ultrawombat.com
      port: 443
  identity:
    keycloak:
      url:
        protocol: $KEYCLOAK_EXT_PROTOCOL_24_9_0
        host: $KEYCLOAK_EXT_HOST_24_9_0
        port: 443
      realm: "/realms/$KEYCLOAK_REALM"
      auth:
        adminUser: "admin"
        existingSecret: "infra-credentials"
        existingSecretKey: "keycloak-admin-password"
    auth:
      enabled: true
      publicIssuerUrl: "$KEYCLOAK_EXT_PROTOCOL_24_9_0://$KEYCLOAK_EXT_HOST_24_9_0/auth/realms/$KEYCLOAK_REALM"
      admin:
        enabled: true
        existingSecret:
          name: "integration-test-credentials"
      webModeler:
        redirectUrl: "https://{{ .Values.global.ingress.host }}/modeler"
      console:
        redirectUrl: "https://{{ .Values.global.ingress.host }}"
        existingSecret:
          name: "integration-test-credentials"
      optimize:
        redirectUrl: "https://{{ .Values.global.ingress.host }}/optimize"
        existingSecret:
          name: "integration-test-credentials"

identity:
  realm:
    enabled: true
    id: $KEYCLOAK_REALM

identityKeycloak:
  enabled: false

identityPostgresql:
  enabled: true
  auth:
    existingSecret: "integration-test-credentials"
    secretKeys:
      adminPasswordSecretKey: identity-keycloak-postgresql-admin-password
      userPasswordKey: identity-keycloak-postgresql-user-password

console:
  keycloak:
    realm: $KEYCLOAK_REALM

connectors:
  security:
    authentication:
      oidc:
        existingSecret:
          name: "integration-test-credentials"

orchestration:
  index:
    prefix: $ORCHESTRATION_INDEX_PREFIX-$FLOW
  security:
    initialization:
      defaultRoles:
        admin:
          users:
            - demo
          clients:
            - venom
    authentication:
      method: oidc
      authenticationRefreshInterval: "PT30S"
      oidc:
        redirectUrl: "https://{{ .Values.global.ingress.host }}/orchestration"
        existingSecret:
          name: "integration-test-credentials"

optimize:
  env:
    - name: CAMUNDA_OPTIMIZE_ELASTICSEARCH_SETTINGS_INDEX_PREFIX
      value: $OPTIMIZE_INDEX_PREFIX-$FLOW
    - name: CAMUNDA_OPTIMIZE_ZEEBE_NAME
      value: $ORCHESTRATION_INDEX_PREFIX-$FLOW
