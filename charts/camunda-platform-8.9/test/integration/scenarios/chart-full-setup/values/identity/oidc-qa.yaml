# QA OIDC auth configuration for 8.9 (Entra ID)
# Layer 2: Auth method - External OIDC provider (Microsoft Entra) for QA
# Expects: base.yaml + base-qa.yaml to be applied alongside this file

global:
  identity:
    auth:
      issuer: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/v2.0
      issuerBackendUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/v2.0
      tokenUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/oauth2/v2.0/token
      authUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/oauth2/v2.0/authorize
      jwksUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/discovery/v2.0/keys
      publicIssuerUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/v2.0
      type: "MICROSOFT"
      identity:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        # this existingSecret must be a string literal
        secret:
          inlineSecret: $ENTRA_APP_CLIENT_SECRET
        initialClaimValue: $INITIAL_CLAIM_VALUE
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.identity.contextPath }}"
      optimize:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        secret:
          existingSecret: integration-test-credentials
          existingSecretKey: entra-child-app-client-secret
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.optimize.contextPath }}"
      webModeler:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        clientApiAudience: $ENTRA_APP_CLIENT_ID
        publicApiAudience: $ENTRA_APP_CLIENT_ID
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.webModeler.contextPath }}"
      console:
        wellKnown: https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        secret:
          existingSecret: integration-test-credentials
          existingSecretKey: entra-child-app-client-secret
        tokenScope: $ENTRA_APP_CLIENT_ID/.default
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.console.contextPath }}"

identityKeycloak:
  enabled: false

orchestration:
  security:
    authentication:
      unprotectedApi: false
      oidc:
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.orchestration.contextPath }}"
        usernameClaim: oid
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        secret:
          existingSecret: integration-test-credentials
          existingSecretKey: entra-child-app-client-secret
    initialization:
      defaultRoles:
        admin:
          users:
            - $INITIAL_CLAIM_VALUE

connectors:
  security:
    authentication:
      oidc:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        clientApiAudience: $ENTRA_APP_CLIENT_ID
        secret:
          existingSecret: integration-test-credentials
          existingSecretKey: entra-child-app-client-secret
        tokenScope: $ENTRA_APP_CLIENT_ID/.default

console:
  env:
    - name: CAMUNDA_IDENTITY_JWKS_URL
      value: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/discovery/v2.0/keys
