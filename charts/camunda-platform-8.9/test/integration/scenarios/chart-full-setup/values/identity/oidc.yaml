# OIDC auth configuration for 8.9 (Entra ID)
# Layer 2: Auth method - External OIDC provider (Microsoft Entra)

global:
  elasticsearch:
    enabled: true
  ingress:
    enabled: true
    className: nginx
    # The Ingress host will be added via CLI.
    host: "$CAMUNDA_HOSTNAME"
    tls:
      enabled: true
      # A wildcard certificate will be used.
      
    annotations:
      external-dns.alpha.kubernetes.io/hostname: "{{ .Values.global.ingress.host }}"
      external-dns.alpha.kubernetes.io/ttl: "60"
  security:
    authentication:
      method: oidc
  identity:
    auth:
      enabled: true
      issuer: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/v2.0
      issuerBackendUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/v2.0
      tokenUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/oauth2/v2.0/token
      jwksUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/discovery/v2.0/keys
      authUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/oauth2/v2.0/authorize
      publicIssuerUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/v2.0
      type: "MICROSOFT"
      orchestration:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        secret:
          existingSecret: integration-test-credentials
          existingSecretKey: entra-child-app-client-secret
        redirectUrl: "https://{{ .Values.global.ingress.host }}/orchestration"
      identity:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        secret: 
          inlineSecret: $ENTRA_APP_CLIENT_SECRET
        initialClaimValue: $ENTRA_APP_OBJECT_ID
        redirectUrl: "https://{{ .Values.global.ingress.host }}/identity"
      optimize:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        secret:
          existingSecret: integration-test-credentials
          existingSecretKey: entra-child-app-client-secret
        redirectUrl: "https://{{ .Values.global.ingress.host }}/optimize"
      connectors:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        clientApiAudience: $ENTRA_APP_CLIENT_ID
        secret:
          existingSecret: integration-test-credentials
          existingSecretKey: entra-child-app-client-secret
        tokenScope: $ENTRA_APP_CLIENT_ID/.default
      webModeler:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        clientApiAudience: $ENTRA_APP_CLIENT_ID
        publicApiAudience: $ENTRA_APP_CLIENT_ID
        redirectUrl: "https://{{ .Values.global.ingress.host }}/modeler"
      console:
        wellKnown: https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        secret:
          existingSecret: integration-test-credentials
          existingSecretKey: entra-child-app-client-secret
        tokenScope: $ENTRA_APP_CLIENT_ID/.default
        redirectUrl: "https://{{ .Values.global.ingress.host }}/"

console:
  env:
    - name: CAMUNDA_IDENTITY_JWKS_URL
      value: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/discovery/v2.0/keys

identityPostgresql:
  enabled: true
  auth:
    existingSecret: "integration-test-credentials"
    secretKeys:
      adminPasswordSecretKey: identity-keycloak-postgresql-admin-password
      userPasswordKey: identity-keycloak-postgresql-user-password

identityKeycloak:
  enabled: false

connectors:
  security:
    authentication:
      method: oidc
      oidc:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        clientApiAudience: $ENTRA_APP_CLIENT_ID
        secret:
          existingSecret: integration-test-credentials
          existingSecretKey: entra-child-app-client-secret
        tokenScope: $ENTRA_APP_CLIENT_ID/.default

webModeler:
  security:
    authentication:
      method: oidc

orchestration:
  security:
    authentication:
      method: oidc
      unprotectedApi: false
      oidc:
        backwardsCompatibleAudiences:
          - operate-api
          - tasklist-api
          - zeebe-api
        usernameClaim: oid
        groupsClaim: ""
    authorizations:
      enabled: true
  env:
    - name: CAMUNDA_DATABASE_SCHEMAMANAGER_VERSIONCHECKRESTRICTIONENABLED
      value: "false"
