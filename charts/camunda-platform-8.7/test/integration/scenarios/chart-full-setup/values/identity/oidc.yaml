# OIDC (Microsoft Entra ID) auth configuration for 8.7
# Layer 2: Auth method - External OIDC provider (Microsoft Entra ID)

global:
  identity:
    auth:
      enabled: true
      issuer: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/v2.0
      issuerBackendUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/v2.0
      tokenUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/oauth2/v2.0/token
      jwksUrl: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/discovery/v2.0/keys
      type: "MICROSOFT"
      identity:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        existingSecret: $ENTRA_APP_CLIENT_SECRET
        initialClaimName: oid
        initialClaimValue: $ENTRA_APP_OBJECT_ID
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.identity.contextPath }}"
      operate:
        clientId: $ENTRA_APP_CLIENT_ID
        existingSecret: $ENTRA_APP_CLIENT_SECRET
        audience: $ENTRA_APP_CLIENT_ID
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.operate.contextPath }}"
      tasklist:
        clientId: $ENTRA_APP_CLIENT_ID
        existingSecret: $ENTRA_APP_CLIENT_SECRET
        audience: $ENTRA_APP_CLIENT_ID
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.tasklist.contextPath }}"
      optimize:
        clientId: $ENTRA_APP_CLIENT_ID
        existingSecret: $ENTRA_APP_CLIENT_SECRET
        audience: $ENTRA_APP_CLIENT_ID
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.optimize.contextPath }}"
      zeebe:
        clientId: "$ENTRA_APP_CLIENT_ID"
        existingSecret: $ENTRA_APP_CLIENT_SECRET
        audience: "$ENTRA_APP_CLIENT_ID"
        tokenScope: "$ENTRA_APP_CLIENT_ID/.default"
      connectors:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        clientApiAudience: $ENTRA_APP_CLIENT_ID
        existingSecret: $ENTRA_APP_CLIENT_SECRET
        tokenScope: $ENTRA_APP_CLIENT_ID/.default
      webModeler:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        clientApiAudience: $ENTRA_APP_CLIENT_ID
        publicApiAudience: $ENTRA_APP_CLIENT_ID
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.webModeler.contextPath }}"
      console:
        clientId: $ENTRA_APP_CLIENT_ID
        audience: $ENTRA_APP_CLIENT_ID
        wellKnown: https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration
        existingSecret: $ENTRA_APP_CLIENT_SECRET
        tokenScope: $ENTRA_APP_CLIENT_ID/.default
        redirectUrl: "https://{{ .Values.global.ingress.host }}{{ .Values.console.contextPath }}"

identityKeycloak:
  enabled: false

identity:
  enabled: true

identityPostgresql:
  enabled: true
  auth:
    existingSecret: integration-test-credentials
    secretKeys:
      adminPasswordSecretKey: identity-keycloak-postgresql-admin-password
      userPasswordKey: identity-keycloak-postgresql-user-password

connectors:
  env:
    - name: OPERATE_CLIENT_SCOPE
      value: $ENTRA_APP_CLIENT_ID/.default

console:
  env:
    - name: CAMUNDA_CONSOLE_EXPERIMENTAL_TAGS
      value: 'true'      
    - name: CAMUNDA_IDENTITY_JWKS_URL
      value: https://login.microsoftonline.com/$ENTRA_APP_DIRECTORY_ID/discovery/v2.0/keys
