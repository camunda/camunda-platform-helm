---
# Source: camunda-platform/templates/identity/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: camunda-platform-test-identity-configuration
  labels:
    app: camunda-platform
    app.kubernetes.io/name: camunda-platform
    app.kubernetes.io/instance: camunda-platform-test
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: camunda-platform
    app.kubernetes.io/component: identity
    app.kubernetes.io/version: "8.8.0-alpha8"
  annotations:
    {}
data:
  application.yaml: |
    # NOTE:
    # It is possible to override the configuration via env vars following the Spring Boot convention.
    # For example, the "identity.url" config path is presented as the "IDENTITY_URL" environment variable.
    # However, it's not possilbe to mix between the configuration and environment variable for the same object
    # like arrays and maps.
    identity:
      url: "http://localhost:8084"
      flags:
        multi-tenancy: "false"

      authProvider:
        issuer-url: "http://localhost:18080/auth/realms/camunda-platform"
        backend-url: "http://camunda-platform-test-keycloak/auth/realms/camunda-platform"

      component-presets:
        connectors:
          applications:
            - name: Connectors
              id: ${CAMUNDA_CONNECTORS_CLIENT_ID:${VALUES_KEYCLOAK_INIT_CONNECTORS_CLIENT_ID:connectors}}
              type: m2m
              secret: ${CAMUNDA_CONNECTORS_SECRET:${VALUES_KEYCLOAK_INIT_CONNECTORS_SECRET:}}
              permissions:
                - audience: "orchestration-api"
                  definition: read:*
        identity:
          apis:
            - name: "Camunda Identity Resource Server"
              audience: "camunda-identity-resource-server"
              permissions:
                - definition: read
                  description: "Read permission"
                - definition: "read:users"
                  description: "Read users permission"
                - definition: write
                  description: "Write permission"
          roles:
            - name: "ManagementIdentity"
              description: "Provides full access to Identity"
              permissions:
                - audience: "camunda-identity-resource-server"
                  definition: read
                - audience: "camunda-identity-resource-server"
                  definition: write
        orchestration:
          applications:
            - name: Orchestration
              id: ${CAMUNDA_ORCHESTRATION_CLIENT_ID:${VALUES_KEYCLOAK_INIT_ORCHESTRATION_CLIENT_ID:orchestration}}
              type: confidential
              secret: ${CAMUNDA_ORCHESTRATION_SECRET:${VALUES_KEYCLOAK_INIT_ORCHESTRATION_SECRET:}}
              root-url: "http://localhost:8080"
              redirect-uris:
                - "/login/oauth2/code/orchestration"
          apis:
            - name: "Orchestration API"
              audience: "orchestration-api"
              permissions:
                - definition: read:*
                  description: "Read permission"
                - definition: write:*
                  description: "Write permission"
          roles:
            - name: "Orchestration"
              description: "Grants full access to Orchestration"
              permissions:
                - audience: "orchestration-api"
                  definition: read:*
                - audience: "orchestration-api"
                  definition: write:*
    keycloak:
      url: "http://camunda-platform-test-keycloak/auth"
      setup:
        user: "admin"
        password: ${VALUES_KEYCLOAK_SETUP_PASSWORD:}
      init:
        orchestration:
          secret: ${VALUES_KEYCLOAK_INIT_ORCHESTRATION_SECRET:}
      # Clients are passed as environment variables.
      clients:
      users:
        - username: "demo"
          password: ${VALUES_IDENTITY_FIRSTUSER_PASSWORD:}
          firstName: "Demo"
          lastName: "User"
          email: "demo@example.org"
          roles:
            - ManagementIdentity
            - Orchestration
      environment:
        clients:
          - name: Identity
            id: "camunda-identity"
            type: CONFIDENTIAL
            secret: ${CAMUNDA_IDENTITY_CLIENT_SECRET:${IDENTITY_CLIENT_SECRET}}
            root-url: "http://localhost:8084"
            redirect-uris:
              - "/auth/login-callback"
      # The presets key should be removed when 8.6.0 of the applications are released
      presets:
        orchestration:
          clients:
            - name: Orchestration
              id: orchestration
              type: confidential
              secret: ${VALUES_KEYCLOAK_INIT_ORCHESTRATION_SECRET:}
              root-url: "http://localhost:8080"
              redirect-uris:
                - "/identity-callback"
    server:
      port: 8084

    spring:
      servlet:
        multipart:
          max-file-size: "10MB"
          max-request-size: "10MB"
      profiles:
        active: keycloak

    camunda:
      identity:
        audience: "camunda-identity-resource-server"
    logging:
      level:
        ROOT: DEBUG
        io.camunda.identity: DEBUG